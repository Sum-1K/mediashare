<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaShare Home</title>
  <link rel="stylesheet" href="/home.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="nav-item active">
      <i class="fa-solid fa-house"></i>
      <span>Home</span>
    </div>
    <div class="nav-item" id="search-btn">
      <i class="fa-solid fa-magnifying-glass"></i>
      <span>Search</span>
    </div>
    <div class="nav-item">
      <i class="fa-solid fa-circle-plus"></i>
      <span>Create</span>
    </div>
    <div class="nav-item" data-link="/chat">
      <i class="fa-regular fa-comment"></i>
      <span>Messages</span>
    </div>
    <div class="nav-item" data-link="/profile">
      <i class="fa-regular fa-user"></i>
      <span>Profile</span>
    </div>
    <div class="nav-item" id="more-nav">
      <i class="fa-solid fa-bars more-btn"></i>
      <span>More</span>
    </div>
  </div>

  <!-- Search Panel -->
  <div class="search-panel" id="search-panel">
    <h3>Search</h3>
    <input type="text" id="search-input" placeholder="Search usernames...">
    <div class="search-results" id="search-results"></div>
  </div>

  <!-- Main Content Wrapper -->
  <div class="main-content">
    <!-- Top Navbar -->
    <header class="top-nav">
      <div class="logo">MediaShare</div>
      <div class="top-icons">
        <a href="/notifications"><i class="fa-regular fa-heart top-icon"></i></a>
        <i class="fa-regular fa-paper-plane top-icon"></i>
      </div>
    </header>

    <!-- Stories Section -->
    <section class="stories">
      <div class="story-group">
        <div class="story-item story-add" th:if="${currentUser != null}">
          <img th:src="@{${currentUser.photo != null ? '/uploads/profile/' + currentUser.photo : '/default.png'}}" alt="Add Story">
          <span>+</span>
        </div>
        <div class="story-item has-story" th:if="${currentUser != null and not #lists.isEmpty(userStories)}" th:attr="data-story-id=${userStories[0].storyId}">
          <img th:src="@{${currentUser.photo != null ? '/uploads/profile/' + currentUser.photo : '/default.png'}}" alt="Your Story">
          <span th:text="${currentUser.user_name}">You</span>
        </div>
        <div th:each="story : ${followingStories}" th:if="${currentUser != null and story != null}" class="story-item has-story" th:attr="data-story-id=${story[0]}">
          <img th:src="${story[7] != null ? '/uploads/profile/' + story[7] : '/default.png'}" th:alt="${story[6]}">
          <span th:text="${story[6]}">Username</span>
        </div>
      </div>
    </section>

    <!-- Fullscreen Story Overlay -->
    <div id="storyOverlay" class="story-overlay">
      <span id="closeStoryOverlay" class="close">&times;</span>
      <button id="storyPrev" class="story-nav">&lt;</button>
      <div class="story-content">
        <img id="storyImage" src="" alt="Story">
        <video id="storyVideo" src="" controls style="display:none;"></video>
        <div id="storyUsername"></div>
      </div>
      <button id="storyNext" class="story-nav">&gt;</button>
    </div>

    <!-- Feed Section -->
    <main class="feed">
      <div th:each="item : ${feedItems}" class="post" th:attr="data-post-id=${item.type == 'POST' ? item.content.postId : ''}, data-reel-id=${item.type == 'REEL' ? item.content.reelId : ''}">
        <!-- Post -->
        <div th:if="${item.type == 'POST'}">
          <div class="post-header">
            <img th:src="@{${postUserMap[item.content.postId].photo != null ? '/uploads/profile/' + postUserMap[item.content.postId].photo : '/default.png'}}" alt="User Photo" />
            <span th:text="${postUserMap[item.content.postId].user_name}"></span>
          </div>
          <div class="post-media" th:if="${postMediaMap[item.content.postId] != null}">
            <div class="carousel">
              <div class="carousel-slide" th:each="media : ${postMediaMap[item.content.postId]}" th:if="${media != null}">
                <img th:if="${media.type.name() == 'PHOTO'}" th:src="@{${#strings.replace(media.url, 'src/main/resources/static', '')}}" class="carousel-img" alt="Post image" />
                <video th:if="${media.type.name() == 'VIDEO'}" class="carousel-img" controls>
                  <source th:src="@{${#strings.replace(media.url, 'src/main/resources/static', '')}}" type="video/mp4"/>
                </video>
              </div>
            </div>
            <button class="prev">&lt;</button>
            <button class="next">&gt;</button>
            <div class="carousel-indicators"></div>
          </div>
          <div class="post-actions">
            <form th:action="@{/like/add}" method="post" style="display:inline;">
              <input type="hidden" name="postId" th:value="${item.content.postId}"/>
              <i class="fa-regular fa-heart like-btn"></i>
            </form>
            <i class="fa-regular fa-comment comment-btn"></i>
            <i class="fa-regular fa-paper-plane"></i>
            <div class="comment-popup">
              <div class="comment-content">
                <div class="comment-header">
                  <h3>Comments</h3>
                  <span class="close-btn">&times;</span>
                </div>
                <div class="comment-list">
                  <div class="comment" th:each="comment : ${postCommentsMap[item.content.postId]}" th:if="${comment != null}">
                    <div class="comment-text">
                      <span class="comment-username" th:text="${commentUsernamesMap[comment.commentId]}"></span>
                      <span th:text="${comment.content}"></span>
                    </div>
                  </div>
                </div>
                <div class="comment-input">
                  <form th:action="@{/comment/add}" method="post">
                    <input type="hidden" name="postId" th:value="${item.content.postId}"/>
                    <input type="text" name="text" placeholder="Add a comment...">
                    <button class="post-comment">Post</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <div class="post-caption" th:if="${item.content.caption != null}">
            <span class="username" th:text="${postUserMap[item.content.postId].user_name}"></span>
            <span th:text="${item.content.caption}"></span>
          </div>
          <div class="post-meta" th:if="${postCreatedAtMap[item.content.postId] != null}">
            <span th:text="${postLikesMap[item.content.postId] != null ? postLikesMap[item.content.postId] + ' likes' : '0 likes'}"></span>
            <small th:text="${#dates.format(postCreatedAtMap[item.content.postId], 'dd MMM yyyy HH:mm')}"></small>
          </div>
        </div>
        <!-- Reel -->
        <div th:if="${item.type == 'REEL'}">
          <div class="post-header">
            <img th:src="@{${reelUserMap[item.content.reelId].photo != null ? '/uploads/profile/' + reelUserMap[item.content.reelId].photo : '/default.png'}}" alt="User Photo" />
            <span th:text="${reelUserMap[item.content.reelId].user_name}"></span>
          </div>
          <div class="reel-video">
            <a th:href="@{/reels/{id}(id=${item.content.reelId})}">
              <video th:src="@{${#strings.replace(item.content.videoFile, 'src/main/resources/static', '')}}" controls preload="metadata" onmouseover="this.play()" onmouseout="this.pause(); this.currentTime=0;"></video>
            </a>
          </div>
          <div class="post-actions">
            <form th:action="@{/reel/like}" method="post" style="display:inline;">
              <input type="hidden" name="reelId" th:value="${item.content.reelId}"/>
              <i class="fa-regular fa-heart like-btn"></i>
            </form>
            <i class="fa-regular fa-comment comment-btn"></i>
            <i class="fa-regular fa-paper-plane"></i>
            <div class="comment-popup">
              <div class="comment-content">
                <div class="comment-header">
                  <h3>Comments</h3>
                  <span class="close-btn">&times;</span>
                </div>
                <div class="comment-list">
                  <div class="comment" th:each="comment : ${reelCommentsMap[item.content.reelId]}" th:if="${comment != null}">
                    <div class="comment-text">
                      <span class="comment-username" th:text="${commentUsernamesMap[comment.commentId]}"></span>
                      <span th:text="${comment.content}"></span>
                    </div>
                  </div>
                </div>
                <div class="comment-input">
                  <form th:action="@{/reel/comment}" method="post">
                    <input type="hidden" name="reelId" th:value="${item.content.reelId}"/>
                    <input type="text" name="text" placeholder="Add a comment...">
                    <button class="post-comment">Post</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <div class="post-caption" th:if="${item.content.caption != null}">
            <span class="username" th:text="${reelUserMap[item.content.reelId].user_name}"></span>
            <span th:text="${item.content.caption}"></span>
          </div>
          <div class="post-meta" th:if="${reelCreatedAtMap[item.content.reelId] != null}">
            <span th:text="${reelLikesMap[item.content.reelId] != null ? reelLikesMap[item.content.reelId] + ' likes' : '0 likes'}"></span>
            <small th:text="${#dates.format(reelCreatedAtMap[item.content.reelId], 'dd MMM yyyy HH:mm')}"></small>
          </div>
        </div>
      </div>
    </main>

    <!-- Bottom Navbar (Mobile) -->
    <nav class="bottom-nav">
      <div class="nav-item active">
        <i class="fa-solid fa-house"></i>
        <span>Home</span>
      </div>
      <div class="nav-item" id="mobile-search-btn">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>Search</span>
      </div>
      <div class="nav-item">
        <i class="fa-solid fa-circle-plus"></i>
        <span>Create</span>
      </div>
      <div class="nav-item" data-link="/chat">
        <i class="fa-regular fa-comment"></i>
        <span>Messages</span>
      </div>
      <div class="nav-item" data-link="/profile">
        <i class="fa-regular fa-user"></i>
        <span>Profile</span>
      </div>
      <div class="nav-item" id="more-nav">
        <i class="fa-solid fa-bars more-btn"></i>
        <span>More</span>
      </div>
    </nav>
  </div>

  <!-- More Menu Popup -->
  <div class="menu-popup" id="menu-popup">
    <a href="/settings" class="menu-item">Settings</a>
    <div class="menu-item">Your activity</div>
    <div class="menu-item">Saved</div>
    <div class="menu-item">Switch appearance</div>
    <div class="menu-item">Report a problem</div>
    <div class="menu-item">Switch accounts</div>
    <div class="menu-item">Log out</div>
  </div>

  <!-- Story Upload Modal -->
  <div class="story-upload-modal" id="storyUploadModal">
    <div class="story-upload-content">
      <div class="story-upload-header">
        <span class="close-btn" id="storyCloseBtn">&times;</span>
      </div>
      <form id="storyForm" th:action="@{/stories}" action="/stories" method="post" enctype="multipart/form-data">
        <div class="story-preview" id="storyPreview"></div>
        <input type="file" id="storyFile" name="storyFile" accept="image/*,video/*" style="display:none;">
        <input type="text" name="highlightTopic" placeholder="Add a caption (optional)">
        <div class="story-input">
          <button type="button" class="add-story-btn" id="addStoryBtn">Choose file</button>
          <button type="submit" class="post-story-btn">Post</button>
        </div>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}" />
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
      const storyUploadModal = document.querySelector('#storyUploadModal');
      storyUploadModal.style.display = 'none';
      initSearch();
      initMoreMenu();
    });

    // Search functionality elements
    const searchBtn = document.getElementById('search-btn');
    const mobileSearchBtn = document.getElementById('mobile-search-btn');
    const searchPanel = document.getElementById('search-panel');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');

    // More menu elements
    const moreBtn = document.getElementById('more-nav');
    const menuPopup = document.getElementById('menu-popup');

    // Like and other interactive elements
    const likes = document.querySelectorAll('.like-btn');
    const navItems = document.querySelectorAll('.nav-item');
    const commentBtns = document.querySelectorAll('.comment-btn');
    const popups = document.querySelectorAll('.comment-popup');
    const closeBtns = document.querySelectorAll('.close-btn');
    const postMedias = document.querySelectorAll('.post-media');
    const storyFileInput = document.querySelector('#storyFile');
    const addStoryBtn = document.querySelector('#addStoryBtn');
    const storyPreview = document.querySelector('#storyPreview');
    const storyCloseBtn = document.querySelector('#storyCloseBtn');

    // Like button functionality
    likes.forEach(like => {
      like.addEventListener('click', () => {
        like.classList.toggle('liked');
        like.classList.toggle('fa-regular');
        like.classList.toggle('fa-solid');
        if (like.closest('form')) {
          like.closest('form').submit();
        }
      });
    });

    // Navigation active state
    navItems.forEach(item => {
      const link = item.getAttribute('data-link');
      item.addEventListener('click', () => {
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        if (link) window.location.href = link;
      });
    });

    // Carousel functionality
    postMedias.forEach(media => {
      const carousel = media.querySelector('.carousel');
      const slides = carousel.querySelectorAll('.carousel-slide');
      const prevBtn = media.querySelector('.prev');
      const nextBtn = media.querySelector('.next');
      const indicatorsContainer = media.querySelector('.carousel-indicators');

      if (slides.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        return;
      }

      slides.forEach((_, index) => {
        const dot = document.createElement('span');
        dot.classList.add('dot');
        if (index === 0) dot.classList.add('active');
        indicatorsContainer.appendChild(dot);
      });

      const dots = indicatorsContainer.querySelectorAll('.dot');
      let currentIndex = 0;

      function updateCarousel() {
        carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach((dot, idx) => dot.classList.toggle('active', idx === currentIndex));
        prevBtn.style.display = currentIndex === 0 ? 'none' : 'block';
        nextBtn.style.display = currentIndex === slides.length - 1 ? 'none' : 'block';
      }

      prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
          currentIndex--;
          updateCarousel();
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentIndex < slides.length - 1) {
          currentIndex++;
          updateCarousel();
        }
      });

      updateCarousel();
    });

    // Comment popup toggle
    commentBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        popups.forEach(popup => popup.classList.remove('active'));
        const popup = btn.closest('.post-actions').querySelector('.comment-popup');
        popup.classList.add('active');
        const rect = popup.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
          popup.style.right = 'auto';
          popup.style.left = '-360px';
        }
      });
    });

    closeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        btn.closest('.comment-popup').classList.remove('active');
      });
    });

    // Story upload functionality
    document.querySelectorAll('.story-add').forEach(btn => {
      btn.addEventListener('click', () => {
        storyUploadModal.style.display = 'flex';
      });
    });

    addStoryBtn.addEventListener('click', () => storyFileInput.click());

    storyFileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        storyPreview.innerHTML = `<${file.type.startsWith('image') ? 'img' : 'video'} src="${url}" class="story-preview-item" ${file.type.startsWith('video') ? 'controls' : ''}></${file.type.startsWith('image') ? 'img' : 'video'}>`;
      }
    });

    storyCloseBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      closeStoryModal();
    });

    window.addEventListener('click', (event) => {
      if (event.target === storyUploadModal) closeStoryModal();
    });

    function closeStoryModal() {
      storyUploadModal.style.display = 'none';
      storyPreview.innerHTML = '';
      storyFileInput.value = '';
    }

    // Story overlay logic
    let allStories = [];
    let userStories = /*[[${userStories}]]*/ [];
    let currentUser = /*[[${currentUser}]]*/ {};

    userStories.forEach(story => {
      allStories.push({
        storyId: story.storyId,
        mediaFile: story.mediaFile,
        userName: currentUser.user_name
      });
    });

    let followingStories = /*[[${followingStories}]]*/ [];
    followingStories.forEach(story => {
      allStories.push({
        storyId: story.storyId,
        mediaFile: story.mediaFile,
        userName: story[6]
      });
    });

    let currentStoryIndex = 0;

    document.querySelectorAll('.story-item.has-story').forEach((storyDiv) => {
      const storyId = storyDiv.getAttribute('data-story-id');
      storyDiv.addEventListener('click', () => {
        const story = allStories.find(s => s.storyId === parseInt(storyId));
        if (story) {
          currentStoryIndex = allStories.indexOf(story);
          showStory(currentStoryIndex);
          document.getElementById('storyOverlay').style.display = 'flex';
        }
      });
    });

    function showStory(index) {
      const story = allStories[index];
      const storyImage = document.getElementById('storyImage');
      const storyVideo = document.getElementById('storyVideo');
      const storyUsername = document.getElementById('storyUsername');
      const overlay = document.getElementById('storyOverlay');

      if (!story || !story.mediaFile) {
        overlay.style.display = 'none';
        return;
      }

      storyUsername.textContent = story.userName;
      overlay.style.display = 'flex';

      if (story.mediaFile.endsWith('.mp4')) {
        storyVideo.src = story.mediaFile;
        storyVideo.style.display = 'block';
        storyImage.style.display = 'none';
        storyVideo.play();
      } else {
        storyImage.src = story.mediaFile;
        storyImage.style.display = 'block';
        storyVideo.style.display = 'none';
        storyVideo.pause();
        storyVideo.src = '';
      }
    }

    document.getElementById('storyNext').addEventListener('click', () => {
      if (currentStoryIndex < allStories.length - 1) {
        currentStoryIndex++;
        showStory(currentStoryIndex);
      }
    });

    document.getElementById('storyPrev').addEventListener('click', () => {
      if (currentStoryIndex > 0) {
        currentStoryIndex--;
        showStory(currentStoryIndex);
      }
    });

    document.getElementById('closeStoryOverlay').addEventListener('click', () => {
      const overlay = document.getElementById('storyOverlay');
      overlay.style.display = 'none';
      const storyVideo = document.getElementById('storyVideo');
      storyVideo.pause();
      storyVideo.src = '';
    });

    // Search functionality
    function initSearch() {
      if (searchBtn) {
        searchBtn.addEventListener('click', () => toggleSearchPanel());
      }
      if (mobileSearchBtn) {
        mobileSearchBtn.addEventListener('click', () => toggleSearchPanel());
      }

      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const query = searchInput.value.trim();
        if (query === "") {
          searchResults.innerHTML = "";
          return;
        }
        searchTimeout = setTimeout(() => performSearch(query), 300);
      });

      document.addEventListener('click', (event) => {
        if (!searchPanel.contains(event.target) && !searchBtn?.contains(event.target) && !mobileSearchBtn?.contains(event.target)) {
          closeSearchPanel();
        }
      });
    }

    function toggleSearchPanel() {
      searchPanel.style.display = searchPanel.style.display === 'flex' ? 'none' : 'flex';
      document.body.classList.toggle('search-open');
      if (searchPanel.style.display === 'flex') searchInput.focus();
    }

    function closeSearchPanel() {
      searchPanel.style.display = 'none';
      document.body.classList.remove('search-open');
    }

    function performSearch(query) {
      searchResults.innerHTML = "<div style='padding: 10px; text-align: center; color: #8e8e8e;'>Searching...</div>";
      fetch(`/search/users?q=${encodeURIComponent(query)}`)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => displaySearchResults(data))
        .catch(error => {
          console.error('Search error:', error);
          searchResults.innerHTML = `
            <div style='padding: 10px; text-align: center; color: #8e8e8e;'>
              Error searching users. Please try again.
            </div>
          `;
        });
    }

    function displaySearchResults(users) {
      searchResults.innerHTML = "";
      if (!users || users.length === 0) {
        searchResults.innerHTML = "<div style='padding: 10px; text-align: center; color: #8e8e8e;'>No users found</div>";
        return;
      }
      users.forEach(user => {
        const resultDiv = document.createElement("div");
        resultDiv.className = "search-result";
        const profilePicUrl = user.photo ? `/uploads/profile/${user.photo}` : '/uploads/default_dp.jpg';
        resultDiv.innerHTML = `
          <img src="${profilePicUrl}" alt="${user.user_name}" onerror="this.src='/uploads/default_dp.jpg'">
          <div>
            <strong>${user.user_name}</strong>
            <div style="font-size: 12px; color: #8e8e8e;">
              ${user.first_name} ${user.last_name}
            </div>
          </div>
        `;
        // Redirect to user profile when clicked
resultDiv.addEventListener('click', () => {
    fetch(`/follow/status/${user.user_id}`)
        .then(response => response.json())
        .then(data => {
            // data should contain: { isFollowing: true/false, privacy: "PUBLIC"/"PRIVATE" }
            if (data.privacy === "PUBLIC") {
                // Public account → always go to profile
                window.location.href = `/profile/${user.user_id}`;
            } else {
                // Private account → only go to profile if following
                if (data.isFollowing) {
                    window.location.href = `/profile/${user.user_id}`;
                } else {
                    // Private and not followed → user page
                    window.location.href = `/user/${user.user_id}`;
                }
            }
        })
        .catch(error => {
            console.error("Error checking follow status:", error);
            // fallback: go to user page
            window.location.href = `/user/${user.user_id}`;
        });
});

            
            searchResults.appendChild(resultDiv);
        });
    }

    // More menu functionality
    function initMoreMenu() {
      if (moreBtn) {
        moreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          menuPopup.classList.toggle('active');
        });
      }
      document.addEventListener('click', () => menuPopup.classList.remove('active'));
    }
  </script>
</body>
</html>