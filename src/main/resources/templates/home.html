<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaShare Home</title>
  <link rel="stylesheet" href="/home.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>
  <!-- Top Navbar -->
  <header class="top-nav">
    <div class="logo">MediaShare</div>
    <div class="top-icons">
      <a href="/notifications"><i class="fa-regular fa-heart top-icon"></i></a>
      <i class="fa-regular fa-paper-plane top-icon"></i>
    </div>
  </header>

<section class="stories">
  <div class="story-group">
    <!-- Add story item (always first) with null check -->
    <div class="story-item story-add" th:if="${currentUser != null}">
      <img th:src="@{${currentUser.photo != null ? currentUser.photo : '/default.png'}}" alt="Add Story">
      <span>+</span>
    </div>

    <!-- Current user's story (if any) with null check -->
    <div th:if="${currentUser != null and not #lists.isEmpty(userStories)}" class="story-item has-story">
      <img th:src="@{${#lists.isEmpty(userStories) ? (currentUser.photo != null ? currentUser.photo : '/default.png') : userStories[0].mediaFile}}" alt="Your Story">
      <span th:text="${currentUser.user_name}">You</span>
    </div>

    <!-- Stories of followed users with debug -->
    <div th:each="story, stat : ${followingStories}" th:if="${currentUser != null}" class="story-item has-story"
         th:attr="data-index=${stat.index}, data-total=${stat.count}"
         th:error="true">
      <img th:src="@{${story.mediaFile != null ? story.mediaFile : '/default.png'}}" alt="Story">
      <span th:text="${#strings.toString(story.userId)}">User</span>
      <!-- Debug info -->
      <span th:text="'Debug: userId=' + ${#strings.toString(story.userId)} + ', mediaFile=' + ${story.mediaFile}" style="color: red; font-size: 10px;"></span>
    </div>

    <!-- Debug if no following stories -->
    <div th:if="${currentUser != null and #lists.isEmpty(followingStories)}" th:text="'No following stories found.'" style="color: red;"></div>
  </div>
</section>

  <!-- Fullscreen Story Overlay -->
  <div id="storyOverlay" class="story-overlay" style="display:none;">
    <span id="closeStoryOverlay" class="close">&times;</span>
    <button id="storyPrev" class="story-nav">&lt;</button>
    <div class="story-content">
      <img id="storyImage" src="" alt="Story">
      <video id="storyVideo" src="" controls style="display:none;"></video>
      <div id="storyUsername"></div>
    </div>
    <button id="storyNext" class="story-nav">&gt;</button>
  </div>

  <!-- Feed Section -->
  <main class="feed">
    <!-- Post 1 -->
    <div class="post" data-post-id="1">
      <div class="post-header">
        <img class="user-pic" src="/priyamvada.jpg" alt="Priyamvada">
        <span class="username">@priyamvada</span>
      </div>
      <div class="post-media">
        <div class="carousel">
          <img class="carousel-img" src="/sunset1.jpg" alt="Sunset 1">
          <img class="carousel-img" src="/sunset2.jpg" alt="Sunset 2">
          <img class="carousel-img" src="/sunset3.jpg" alt="Sunset 3">
        </div>
        <button class="prev">&lt;</button>
        <button class="next">&gt;</button>
        <div class="carousel-indicators"></div>
      </div>
      <div class="post-actions">
        <i class="fa-regular fa-heart like-btn"></i>
        <i class="fa-regular fa-comment comment-btn" data-post-id="1"></i>
        <i class="fa-regular fa-paper-plane"></i>
        <div class="comment-popup" id="comment-popup-1">
          <div class="comment-content">
            <div class="comment-header">
              <h3>Comments</h3>
              <span class="close-btn">&times;</span>
            </div>
            <div class="comment-list">
              <div class="comment">
                <img src="/priyamvada.jpg" alt="Priyamvada" class="comment-user-pic">
                <div class="comment-text">
                  <span class="comment-username">priyamvada</span>
                  Nice sunset! ðŸŒ…
                </div>
              </div>
              <div class="comment">
                <img src="/user2.jpg" alt="User 2" class="comment-user-pic">
                <div class="comment-text">
                  <span class="comment-username">user2</span>
                  Beautiful view!
                </div>
              </div>
            </div>
            <div class="comment-input">
              <input type="text" placeholder="Add a comment...">
              <button class="post-comment">Post</button>
            </div>
          </div>
        </div>
      </div>
      <div class="post-caption">
        <span class="username">priyamvada</span> Enjoying the sunset! ðŸŒ…
      </div>
    </div>

    <!-- Post 2 -->
    <div class="post" data-post-id="2">
      <div class="post-header">
        <img class="user-pic" src="/user2.jpg" alt="User 2">
        <span class="username">user2</span>
      </div>
      <div class="post-media">
        <div class="carousel">
          <img class="carousel-img" src="/coffee1.jpg" alt="Coffee 1">
          <img class="carousel-img" src="/coffee2.jpg" alt="Coffee 2">
        </div>
        <button class="prev">&lt;</button>
        <button class="next">&gt;</button>
        <div class="carousel-indicators"></div>
      </div>
      <div class="post-actions">
        <i class="fa-regular fa-heart like-btn"></i>
        <i class="fa-regular fa-comment comment-btn" data-post-id="2"></i>
        <i class="fa-regular fa-paper-plane"></i>
        <div class="comment-popup" id="comment-popup-2">
          <div class="comment-content">
            <div class="comment-header">
              <h3>Comments</h3>
              <span class="close-btn">&times;</span>
            </div>
            <div class="comment-list">
              <div class="comment">
                <img src="/user2.jpg" alt="User 2" class="comment-user-pic">
                <div class="comment-text">
                  <span class="comment-username">user2</span>
                  Love this coffee! â˜•
                </div>
              </div>
              <div class="comment">
                <img src="/priyamvada.jpg" alt="Priyamvada" class="comment-user-pic">
                <div class="comment-text">
                  <span class="comment-username">priyamvada</span>
                  Looks delicious!
                </div>
              </div>
            </div>
            <div class="comment-input">
              <input type="text" placeholder="Add a comment...">
              <button class="post-comment">Post</button>
            </div>
          </div>
        </div>
      </div>
      <div class="post-caption">
        <span class="username">user2</span> Coffee vibes â˜•
      </div>
    </div>
  </main>

  <!-- Bottom Navbar -->
  <nav class="bottom-nav">
    <div class="nav-item">
      <i class="fa-solid fa-house active"></i>
      <span>Home</span>
    </div>
    <div class="nav-item">
      <i class="fa-solid fa-magnifying-glass"></i>
      <span>Search</span>
    </div>
    <div class="nav-item">
      <i class="fa-solid fa-circle-plus"></i>
      <span>Create</span>
    </div>
    <div class="nav-item" data-link="/chat">
      <i class="fa-regular fa-comment"></i>
      <span>Messages</span>
    </div>
    <div class="nav-item" data-link="/profile">
      <i class="fa-regular fa-user"></i>
      <span>Profile</span>
    </div>
    <div class="nav-item" id="more-nav">
      <i class="fa-solid fa-bars more-btn"></i>
      <span>More</span>
    </div>
    <div class="menu-popup">
      <a href="/settings" class="menu-item">Settings</a>
      <div class="menu-item">Your activity</div>
      <div class="menu-item">Saved</div>
      <div class="menu-item">Switch appearance</div>
      <div class="menu-item">Report a problem</div>
      <div class="menu-item">Switch accounts</div>
      <div class="menu-item">Log out</div>
    </div>
  </nav>

  <!-- Story Upload Modal -->
  <div class="story-upload-modal" id="storyUploadModal">
    <div class="story-upload-content">
      <div class="story-upload-header">
        <span class="close-btn" id="storyCloseBtn">&times;</span>
      </div>
      <form id="storyForm" th:action="@{/stories}" action="/stories" method="post" enctype="multipart/form-data">
        <div class="story-preview" id="storyPreview"></div>
        <input type="file" id="storyFile" name="storyFile" accept="image/*,video/*" style="display:none;">
        <input type="text" name="highlightTopic" placeholder="Add a caption (optional)">
        <div class="story-input">
          <button type="button" class="add-story-btn" id="addStoryBtn">Choose file</button>
          <button type="submit" class="post-story-btn">Post</button>
        </div>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}" />
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
      const storyUploadModal = document.querySelector('#storyUploadModal');
      storyUploadModal.style.display = 'none';
    });

    const likes = document.querySelectorAll('.like-btn');
    const navItems = document.querySelectorAll('.nav-item');
    const commentBtns = document.querySelectorAll('.comment-btn');
    const popups = document.querySelectorAll('.comment-popup');
    const closeBtns = document.querySelectorAll('.close-btn');
    const moreBtn = document.querySelector('.more-btn');
    const menuPopup = document.querySelector('.menu-popup');
    const postMedias = document.querySelectorAll('.post-media');
    const storyUploadModal = document.querySelector('#storyUploadModal');
    const storyFileInput = document.querySelector('#storyFile');
    const addStoryBtn = document.querySelector('#addStoryBtn');
    const storyPreview = document.querySelector('#storyPreview');
    const storyCloseBtn = document.querySelector('#storyCloseBtn');

    likes.forEach(like => {
      like.addEventListener('click', () => {
        like.classList.toggle('liked');
        like.classList.toggle('fa-regular');
        like.classList.toggle('fa-solid');
      });
    });

    navItems.forEach(item => {
      const link = item.getAttribute('data-link');
      item.addEventListener('click', () => {
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        if (link) window.location.href = link;
      });
    });

    postMedias.forEach(media => {
      const carousel = media.querySelector('.carousel');
      const images = carousel.querySelectorAll('.carousel-img');
      const prevBtn = media.querySelector('.prev');
      const nextBtn = media.querySelector('.next');
      const indicatorsContainer = media.querySelector('.carousel-indicators');

      if (images.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        return;
      }

      images.forEach((_, index) => {
        const dot = document.createElement('span');
        dot.classList.add('dot');
        if (index === 0) dot.classList.add('active');
        indicatorsContainer.appendChild(dot);
      });

      const dots = indicatorsContainer.querySelectorAll('.dot');
      let currentIndex = 0;

      function updateCarousel() {
        carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach((dot, idx) => dot.classList.toggle('active', idx === currentIndex));
        prevBtn.style.display = currentIndex === 0 ? 'none' : 'block';
        nextBtn.style.display = currentIndex === images.length - 1 ? 'none' : 'block';
      }

      prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
          currentIndex--;
          updateCarousel();
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentIndex < images.length - 1) {
          currentIndex++;
          updateCarousel();
        }
      });

      updateCarousel();
    });

    moreBtn.addEventListener('click', () => {
      menuPopup.classList.toggle('active');
    });

    document.addEventListener('click', (event) => {
      if (!moreBtn.contains(event.target) && !menuPopup.contains(event.target)) {
        menuPopup.classList.remove('active');
      }
    });

    commentBtns.forEach((btn, index) => {
      btn.addEventListener('click', () => {
        popups.forEach(popup => popup.classList.remove('active'));
        const popup = popups[index];
        popup.classList.add('active');
        const rect = popup.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
          popup.style.right = 'auto';
          popup.style.left = '-360px';
        }
      });
    });

    closeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        btn.closest('.comment-popup').classList.remove('active');
      });
    });

    document.querySelectorAll('.story-add').forEach(btn => {
      btn.addEventListener('click', () => {
        storyUploadModal.style.display = 'flex';
      });
    });

    addStoryBtn.addEventListener('click', () => storyFileInput.click());

    storyFileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        storyPreview.innerHTML = `<${file.type.startsWith('image') ? 'img' : 'video'} src="${url}" class="story-preview-item" ${file.type.startsWith('video') ? 'controls' : ''}></${file.type.startsWith('image') ? 'img' : 'video'}>`;
      }
    });

    storyCloseBtn.addEventListener('click', closeStoryModal);

    window.addEventListener('click', (event) => {
      if (event.target === storyUploadModal) closeStoryModal();
    });

    function closeStoryModal() {
      storyUploadModal.style.display = 'none';
      storyPreview.innerHTML = '';
      storyFileInput.value = '';
    }

    let currentUserStories = /*[[${userStories}]]*/ [];
    let currentUser = /*[[${currentUser}]]*/ {};
    let currentStoryIndex = 0;

    document.querySelectorAll('.story-item.has-story').forEach(storyDiv => {
      storyDiv.addEventListener('click', () => {
        currentStoryIndex = 0;
        showStory(currentStoryIndex);
        document.getElementById('storyOverlay').style.display = 'flex';
      });
    });

    function showStory(index) {
      const story = currentUserStories[index];
      const storyImage = document.getElementById('storyImage');
      const storyVideo = document.getElementById('storyVideo');
      const storyUsername = document.getElementById('storyUsername');
      const overlay = document.getElementById('storyOverlay');

      if (!story || !story.mediaFile) {
        overlay.style.display = 'none';
        return;
      }

      storyUsername.textContent = currentUser.user_name;
      overlay.style.display = 'flex';

      if (story.mediaFile.endsWith('.mp4')) {
        storyVideo.src = story.mediaFile;
        storyVideo.style.display = 'block';
        storyImage.style.display = 'none';
        storyVideo.play();
      } else {
        storyImage.src = story.mediaFile;
        storyImage.style.display = 'block';
        storyVideo.style.display = 'none';
        storyVideo.pause();
        storyVideo.src = '';
      }
    }

    document.getElementById('storyNext').addEventListener('click', () => {
      if (currentStoryIndex < currentUserStories.length - 1) {
        currentStoryIndex++;
        showStory(currentStoryIndex);
      }
    });

    document.getElementById('storyPrev').addEventListener('click', () => {
      if (currentStoryIndex > 0) {
        currentStoryIndex--;
        showStory(currentStoryIndex);
      }
    });

    document.getElementById('closeStoryOverlay').addEventListener('click', () => {
      const overlay = document.getElementById('storyOverlay');
      overlay.style.display = 'none';
      const storyVideo = document.getElementById('storyVideo');
      storyVideo.pause();
      storyVideo.src = '';
    });
  </script>
</body>
</html>