<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaShare Home</title>
  <link rel="stylesheet" href="/home.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Dynamic Theme CSS -->
  <link rel="stylesheet" th:href="@{/css/theme.css}">
  <style th:inline="css">
      :root {
          /* Light theme (default) */
          --bg-color: #fafafa;
          --text-color: #262626;
          --card-bg: #ffffff;
          --border-color: #dbdbdb;
          --secondary-text: #8e8e8e;
          --hover-bg: #fafafa;
      }
      
      [data-theme="dark"] {
          --bg-color: #121212;
          --text-color: #ffffff;
          --card-bg: #1e1e1e;
          --border-color: #363636;
          --secondary-text: #a8a8a8;
          --hover-bg: #262626;
      }
      
      body {
          background-color: var(--bg-color);
          color: var(--text-color);
          transition: background-color 0.3s ease, color 0.3s ease;
      }
      /* Reset & Basics */
* /* Reset & Basics */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
}

body {
  background: #fafafa;
  color: #262626;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Sidebar Styles - Fixed to match profile page */
.sidebar {
  background-color: #fff;
  border-right: 1px solid #dbdbdb;
  width: 80px;
  height: 100vh;
  position: fixed;
  top: 0;
  left: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 70px;
  z-index: 999;
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
}

.sidebar-item {
  margin: 15px 0;
}

.sidebar-item a {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  color: #262626;
  font-size: 0.8rem;
  transition: color 0.2s;
  padding: 8px;
  border-radius: 8px;
}

.sidebar-item a:hover {
  color: #000;
  background-color: #fafafa;
}

.sidebar-item i {
  font-size: 1.5rem;
  margin-bottom: 4px;
}

.sidebar-item span {
  font-weight: 400;
  text-transform: capitalize;
  text-align: center;
}

.sidebar-item.active a,
.sidebar-item a.active {
  color: #0095f6;
}

/* Search Panel Styles */
.search-panel {
  position: fixed;
  top: 0;
  left: 80px;
  width: 300px;
  height: 100vh;
  background-color: #fff;
  border-right: 1px solid #dbdbdb;
  z-index: 998;
  display: none;
  flex-direction: column;
  padding: 70px 15px 15px;
}

.search-panel h3 {
  margin-bottom: 20px;
  font-size: 18px;
}

.search-panel input {
  width: 100%;
  padding: 12px;
  border: 1px solid #dbdbdb;
  border-radius: 8px;
  margin-bottom: 20px;
  font-size: 14px;
  background-color: #fafafa;
}

.search-panel input:focus {
  outline: none;
  border-color: #a8a8a8;
}

.search-results {
  flex: 1;
  overflow-y: auto;
}

.search-result {
  padding: 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
}

.search-result:hover {
  background-color: #fafafa;
}

.search-result img {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  object-fit: cover;
}

.search-result div {
  font-size: 14px;
  font-weight: 500;
}

/* Main Content Wrapper - CENTERED */
.main-content {
  margin-left: 460px; /* Space from sidebar */
  margin-right: auto;
  max-width: 630px;
  width: 100%;
  transition: margin-left 0.3s ease;
}

/* When search panel is open */
body.search-open .main-content {
  margin-left: 400px; /* sidebar + search panel width */
}

/* Theme Toggle Button */
.theme-toggle {
  background: none;
  border: none;
  font-size: 1.3rem;
  cursor: pointer;
  color: var(--text-color);
  transition: transform 0.2s;
  padding: 5px;
  border-radius: 50%;
}

.theme-toggle:hover {
  transform: scale(1.1);
  background-color: var(--hover-bg);
}

/* Top Navbar - CENTERED */
.top-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  background: #fff;
  position: sticky;
  top: 0;
  z-index: 997;
  border-bottom: 1px solid #dbdbdb;
  max-width: 630px;
  width: 100%;
  margin: 0 auto;
}

.top-nav .logo {
  font-weight: 700;
  font-size: 1.6rem;
  letter-spacing: 1px;
  font-family: 'Trebuchet MS', sans-serif;
  color: #262626;
}

.top-icons {
  display: flex;
  gap: 15px;
  align-items: center;
}

.nav-link {
  text-decoration: none;
  color: #262626;
  font-size: 1rem;
  padding: 8px 12px;
  border-radius: 6px;
  transition: background-color 0.2s;
}

.nav-link:hover {
  background-color: #fafafa;
}

/* Stories Section - CENTERED */
.stories {
  display: flex;
  flex-direction: row;
  overflow-x: auto;
  padding: 10px 0;
  background: #fff;
  border-bottom: 1px solid #dbdbdb;
  max-width: 630px;
  width: 100%;
  margin: 0 auto;
  scroll-behavior: smooth;
}

.stories::-webkit-scrollbar {
  display: none;
}

.story-group {
  display: flex;
  gap: 15px;
  align-items: center;
  padding: 0 10px;
}

.story-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 68px;
  max-width: 68px;
  cursor: pointer;
  position: relative;
}

.story-item img {
  width: 68px;
  height: 68px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid transparent;
  transition: transform 0.3s;
}

.story-item.has-story img {
  border: 2px solid;
  border-image: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888) 1;
}

.story-item:hover img {
  transform: scale(1.1);
}

.story-item span {
  font-size: 0.7rem;
  color: #262626;
  margin-top: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 60px;
  text-align: center;
}

.story-item.story-add img {
  background: #e0e0e0;
}

.story-item.story-add span {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.2rem;
  color: #262626;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 50%;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Feed - CENTERED */
.feed {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 20px 0;
  max-width: 630px;
  width: 100%;
  margin: 0 auto;
}

.post {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #dbdbdb;
  position: relative;
  transition: transform 0.3s, box-shadow 0.3s;
}

.post:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.post-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
}

.post-header img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #dbdbdb;
}

.post-header span {
  font-weight: 600;
  font-size: 0.9rem;
  color: #262626;
}

/* Post Media (Carousel) */
.post-media {
  position: relative;
  width: 100%;
  overflow: hidden;
}

.carousel {
  display: flex;
  transition: transform 0.3s ease;
}

.carousel-slide {
  flex: 0 0 100%;
}

.carousel-img {
  width: 100%;
  height: auto;
  max-height: 600px;
  object-fit: cover;
}

.prev, .next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.7);
  border: none;
  font-size: 1.4rem;
  padding: 8px 12px;
  cursor: pointer;
  color: #262626;
  z-index: 10;
  border-radius: 50%;
  transition: background 0.2s;
}

.prev:hover, .next:hover {
  background: rgba(255, 255, 255, 0.9);
}

.prev {
  left: 12px;
}

.next {
  right: 12px;
}

.carousel-indicators {
  position: absolute;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
}

.dot {
  width: 6px;
  height: 6px;
  background: #fff;
  border-radius: 50%;
  opacity: 0.5;
}

.dot.active {
  opacity: 1;
}

/* Reel Video */
.reel-video video {
  width: 100%;
  max-height: 600px;
  object-fit: contain;
  border-radius: 8px;
}

/* Post Actions */
.post-actions {
  display: flex;
  gap: 12px;
  padding: 12px 16px;
  font-size: 1.4rem;
  color: #262626;
  position: relative;
}

.post-actions i {
  cursor: pointer;
  transition: transform 0.2s, color 0.2s;
}

.post-actions i:hover {
  transform: scale(1.1);
}

.liked {
  color: #ed4956;
}

/* Comment Popup */
.comment-popup {
  display: none;
  position: absolute;
  top: -220px;
  right: 220px;
  background: rgba(0, 0, 0, 0.5);
  width: 320px;
  max-height: 75vh;
  overflow-y: auto;
  z-index: 300;
  border-radius: 8px;
}

.comment-popup.active {
  display: block;
}

.comment-content {
  background: #fff;
  width: 100%;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid #dbdbdb;
}

.comment-header h3 {
  font-size: 1.1rem;
  color: #262626;
}

.close-btn {
  font-size: 1.4rem;
  cursor: pointer;
  color: #262626;
}

.comment-list {
  padding: 12px 16px;
  flex: 1;
  overflow-y: auto;
}

.comment {
  display: flex;
  align-items: flex-start;
  margin-bottom: 12px;
}

.comment-text {
  font-size: 0.85rem;
  color: #262626;
}

.comment-username {
  font-weight: 600;
  margin-right: 4px;
}

.comment-input {
  display: flex;
  padding: 12px 16px;
  border-top: 1px solid #dbdbdb;
}

.comment-input input {
  flex: 1;
  padding: 8px;
  border: 1px solid #dbdbdb;
  border-radius: 4px;
  outline: none;
}

.comment-input button {
  margin-left: 8px;
  padding: 8px 16px;
  background: #0095f6;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* Post Caption */
.post-caption {
  padding: 0 16px 12px;
  font-size: 0.9rem;
  color: #262626;
  line-height: 1.4;
}

.post-caption .username {
  margin-right: 6px;
  font-weight: 600;
}

/* Post Meta */
.post-meta {
  padding: 0 16px 12px;
  font-size: 0.8rem;
  color: #8e8e8e;
}

/* Bottom Navbar */
.bottom-nav {
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 10px 0;
  background: #fff;
  position: fixed;
  bottom: 0;
  width: 100%;
  max-width: 1075px;
  margin: 0 auto;
  border-top: 1px solid #dbdbdb;
  z-index: 100;
}

.bottom-nav .nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 0.75rem;
  color: #262626;
  cursor: pointer;
  transition: color 0.2s;
  padding: 8px;
}

.bottom-nav .nav-item i {
  font-size: 1.4rem;
  margin-bottom: 2px;
}

.bottom-nav .nav-item span {
  font-weight: 400;
  text-transform: capitalize;
}

.bottom-nav .nav-item.active {
  color: #0095f6;
}

.bottom-nav .nav-item:hover {
  color: #000;
}

/* Menu Popup */
.menu-popup {
  display: none;
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  width: 200px;
  padding: 8px 0;
  border: 1px solid #dbdbdb;
}

.menu-popup.active {
  display: block;
}

.menu-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  color: #262626;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s;
  text-decoration: none;
  border: none;
  background: none;
  width: 100%;
  font-family: inherit;
}

.menu-item:hover {
  background: #fafafa;
}

.logout-form-menu {
  width: 100%;
  margin: 0;
  padding: 0;
}

.logout-menu-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  color: #262626;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s;
  text-decoration: none;
  border: none;
  background: none;
  width: 100%;
  font-family: inherit;
}

.logout-menu-btn:hover {
  background: #fafafa;
}

/* Story Upload Modal */
.story-upload-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: flex;
  justify-content: center;
  align-items: center;
}

.story-upload-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  position: relative;
}

.story-upload-header {
  position: absolute;
  top: 12px;
  right: 12px;
}

.story-upload-header .close-btn {
  font-size: 1.4rem;
  cursor: pointer;
  color: #262626;
}

.story-preview {
  margin: 15px 0;
  height: 250px;
  overflow: hidden;
  border: 1px solid #dbdbdb;
  border-radius: 8px;
}

.story-preview-item {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.story-input {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.add-story-btn, .post-story-btn {
  padding: 10px;
  background: #0095f6;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.post-story-btn {
  background: #4caf50;
}

.add-story-btn:hover, .post-story-btn:hover {
  opacity: 0.9;
}

/* Story Overlay */
.story-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.story-overlay .close {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 32px;
  color: #fff;
  cursor: pointer;
  z-index: 1001;
}

.story-content {
  position: relative;
  max-width: 400px;
  max-height: 70vh;
  text-align: center;
  width: 90%;
}

.story-overlay img, .story-overlay video {
  max-width: 100%;
  max-height: 100%;
  border-radius: 12px;
  object-fit: contain;
}

.story-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 36px;
  color: #fff;
  background: transparent;
  border: none;
  cursor: pointer;
  user-select: none;
  z-index: 1001;
  padding: 20px;
}

#storyPrev { left: 10px; }
#storyNext { right: 10px; }

#storyUsername {
  color: #fff;
  margin-top: 12px;
  font-weight: bold;
  font-size: 16px;
}

/* Responsive Styles */
@media (min-width: 1265px) {
  .bottom-nav {
    display: none;
  }
}

@media (max-width: 1264px) {
  .sidebar {
    display: none;
  }
  .search-panel {
    left: 0;
  }
  .main-content {
    margin-left: auto;
    margin-right: auto;
  }
  body.search-open .main-content {
    margin-left: 300px;
  }
}

@media (max-width: 768px) {
  .main-content {
    max-width: 100%;
    padding: 0;
    margin-left: 0;
  }
  body.search-open .main-content {
    margin-left: 0;
    transform: translateX(300px);
  }
  .search-panel {
    width: 300px;
  }
  .stories {
    padding: 8px 0;
  }
  .story-group {
    gap: 10px;
    padding: 0 8px;
  }
  .story-item {
    min-width: 60px;
    max-width: 60px;
  }
  .story-item img {
    width: 56px;
    height: 56px;
  }
  .story-item span {
    font-size: 0.65rem;
    max-width: 50px;
  }
  .feed {
    padding: 15px 0;
    gap: 15px;
  }
  .post {
    border-radius: 0;
    border-left: none;
    border-right: none;
  }
  .carousel-img {
    max-height: 500px;
  }
  .prev, .next {
    font-size: 1.2rem;
    padding: 6px 10px;
  }
  .menu-popup {
    bottom: 70px;
    width: 180px;
  }
}

/* Dark theme support */
[data-theme="dark"] .sidebar,
[data-theme="dark"] .search-panel,
[data-theme="dark"] .top-nav,
[data-theme="dark"] .stories,
[data-theme="dark"] .post,
[data-theme="dark"] .bottom-nav,
[data-theme="dark"] .menu-popup,
[data-theme="dark"] .story-upload-content {
  background-color: var(--card-bg);
  border-color: var(--border-color);
}

[data-theme="dark"] .sidebar-item a,
[data-theme="dark"] .nav-link,
[data-theme="dark"] .story-item span,
[data-theme="dark"] .post-header span,
[data-theme="dark"] .menu-item {
  color: var(--text-color);
}

[data-theme="dark"] .sidebar-item a:hover,
[data-theme="dark"] .menu-item:hover {
  background-color: var(--hover-bg);
}

[data-theme="dark"] body {
  background-color: var(--bg-color);
}
  </style>
</head>
<body th:attr="data-theme=${userTheme}" data-theme="light">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-item active">
      <a th:href="@{/home}">
        <i class="fa-solid fa-house"></i>
        <span>Home</span>
      </a>
    </div>
    <div class="sidebar-item" id="search-btn">
      <a href="javascript:void(0);">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>Search</span>
      </a>
    </div>
    <div class="sidebar-item" id="create-post">
      <a href="javascript:void(0);">
        <i class="fa-solid fa-circle-plus"></i>
        <span>Create</span>
      </a>
    </div>
    <div class="sidebar-item">
      <a th:href="@{/chat}">
        <i class="fa-regular fa-comment"></i>
        <span>Messages</span>
      </a>
    </div>
    <div class="sidebar-item">
      <a th:href="@{/profile}">
        <i class="fa-regular fa-user"></i>
        <span>Profile</span>
      </a>
    </div>
    <div class="sidebar-item" id="more-nav">
      <a href="javascript:void(0);">
        <i class="fa-solid fa-bars more-btn"></i>
        <span>More</span>
      </a>
    </div>
  </div>

  <!-- Search Panel -->
  <div class="search-panel" id="search-panel">
    <h3>Search</h3>
    <input type="text" id="search-input" placeholder="Search usernames...">
    <div class="search-results" id="search-results"></div>
  </div>

  <!-- Main Content Wrapper -->
   <div class="menu-popup" id="menu-popup">
    <a href="/settings" class="menu-item">Settings</a>
  </div>
  <div class="main-content">
    <!-- Top Navbar -->
    <header class="top-nav">
      <div class="logo">MediaShare</div>
      <div class="top-icons">
          <!-- Theme Toggle Button -->
          <button id="themeToggle" class="theme-toggle">
              <i class="fa-solid fa-sun" id="themeIcon"></i>
          </button>
          
          <!-- Notifications Link -->
          <a href="/notifications" class="nav-link">
              üîî Notifications
          </a>
      </div>
    </header>

    <!-- Stories Section -->
    <section class="stories">
      <div class="story-group">
        <div class="story-item story-add" th:if="${currentUser != null}">
          <img th:src="@{${currentUser.photo != null ? '/uploads/profile/' + currentUser.photo : '/default.png'}}" alt="Add Story">
          <span>+</span>
        </div>
        <div class="story-item has-story" 
     th:if="${currentUser != null and not #lists.isEmpty(userStories)}" 
     th:attr="data-story-id=${userStories[0].storyId}, data-user-name=${currentUser.user_name}">
  <img th:src="@{${currentUser.photo != null ? '/uploads/profile/' + currentUser.photo : '/default.png'}}" alt="Your Story">
  <span th:text="${currentUser.user_name}">You</span>
</div>

       <div th:each="story : ${followingStories}" 
     th:if="${currentUser != null and story != null}" 
     class="story-item has-story" 
     th:attr="data-story-id=${story[0]}, data-user-name=${story[6]}">
  <img th:src="${story[7] != null ? '/uploads/profile/' + story[7] : '/default.png'}" th:alt="${story[6]}">
  <span th:text="${story[6]}">Username</span>
</div>
      </div>
    </section>

    <!-- Fullscreen Story Overlay -->
    <div id="storyOverlay" class="story-overlay">
      <span id="closeStoryOverlay" class="close">&times;</span>
      <button id="storyPrev" class="story-nav">&lt;</button>
      <div class="story-content">
        <img id="storyImage" src="" alt="Story">
        <video id="storyVideo" src="" controls style="display:none;"></video>
        <div id="storyUsername"></div>

        <!-- Archive Toggle Button -->
    <button id="toggleArchiveBtn"
            style="margin-top:10px; padding:6px 12px; background:#333; color:#fff; border:none; border-radius:8px; cursor:pointer;">
      Archive
    </button>

        <!-- Story Actions -->
<div class="story-actions" style="margin-top:15px; display:flex; gap:15px; align-items:center;">
  <!-- Like button -->
  <button id="storyLikeBtn" 
          style="background:#ff4d4d; color:white; border:none; border-radius:8px; padding:6px 12px; cursor:pointer;">
    ‚ù§Ô∏è Like (<span id="storyLikeCount">0</span>)
  </button>

  <!-- Comment button -->
  <button id="storyCommentBtn"
          style="background:#007bff; color:white; border:none; border-radius:8px; padding:6px 12px; cursor:pointer;">
    üí¨ Comment
  </button>
</div>

<!-- Comment modal -->
<div id="storyCommentModal" style="display:none; margin-top:10px; border-top:1px solid #ddd; padding-top:10px;">
  <textarea id="storyCommentText" rows="2" placeholder="Write a comment..." 
            style="width:100%; border-radius:8px; padding:5px;"></textarea>
  <button id="storySubmitCommentBtn" 
          style="margin-top:6px; background:#28a745; color:white; border:none; border-radius:8px; padding:6px 12px; cursor:pointer;">
    Post
  </button>
</div>
      </div>
      <button id="storyNext" class="story-nav">&gt;</button>
    </div>

    <!-- Feed Section -->
    <main class="feed">
      <div th:each="item : ${feedItems}" class="post" th:attr="data-post-id=${item.type == 'POST' ? item.content.postId : ''}, data-reel-id=${item.type == 'REEL' ? item.content.reelId : ''}">
          <div th:if="${item.type == 'POST'}" 
     class="post-card"
     th:attr="data-post-id=${item.content.postId}">
     
          <!-- Profile link stays separate -->
  <div class="post-header">
    <a href="#" th:attr="data-user-id=${postUserMap[item.content.postId].user_id}" class="profile-link">
      <img th:src="@{${postUserMap[item.content.postId].photo != null ? '/uploads/profile/' + postUserMap[item.content.postId].photo : '/default.png'}}"
           alt="User Photo" style="cursor: pointer;" />
      <span th:text="${postUserMap[item.content.postId].user_name}" style="cursor: pointer;"></span>
    </a>
  </div>

  <!-- Make the whole post clickable -->
  <a th:href="@{/post/{id}(id=${item.content.postId})}" style="text-decoration: none; color: inherit;">
  <div class="clickable-post"
       style="cursor:pointer;">

      <!-- Keep your existing media, caption, and meta -->
      <div class="post-media" th:if="${postMediaMap[item.content.postId] != null}">
        <div class="carousel">
          <div class="carousel-slide" th:each="media : ${postMediaMap[item.content.postId]}" th:if="${media != null}">
            <img th:if="${media.type.name() == 'PHOTO'}" th:src="@{${#strings.replace(media.url, 'src/main/resources/static', '')}}" class="carousel-img" alt="Post image" />
            <video th:if="${media.type.name() == 'VIDEO'}" class="carousel-img" controls>
              <source th:src="@{${#strings.replace(media.url, 'src/main/resources/static', '')}}" type="video/mp4"/>
            </video>
          </div>
        </div>
        <button class="prev">&lt;</button>
        <button class="next">&gt;</button>
        <div class="carousel-indicators"></div>
      </div>
      
      <div class="post-caption" th:if="${item.content.caption != null}">
        <span class="username" th:text="${postUserMap[item.content.postId].user_name}"></span>
        <span th:text="${item.content.caption}"></span>
      </div>
      <div class="post-meta" th:if="${postCreatedAtMap[item.content.postId] != null}">
        <span th:text="${postLikesMap[item.content.postId] != null ? postLikesMap[item.content.postId] + ' likes' : '0 likes'}"></span>
        <small th:text="${#dates.format(postCreatedAtMap[item.content.postId], 'dd MMM yyyy HH:mm')}"></small>
      </div>

  </div> <!-- clickable-post ends -->
  </a>
  <!-- Comments section remains separate (not clickable for detail) -->
  <div class="view-comments" style="color: #555; font-size: 13px; cursor: pointer;"
       th:attr="data-post-id=${item.content.postId}">
    View comments (<span th:text="${postCommentsMap[item.content.postId]?.size() != null ? postCommentsMap[item.content.postId].size() : 0}">0</span>)
  </div>

  <div class="comments-popup"
       th:attr="id='comments-post-' + ${item.content.postId}"
       style="display:none; background:#f9f9f9; padding:8px; border-radius:6px; margin-top:5px;">
    <div th:each="comment : ${postCommentsMap[item.content.postId]}">
      <strong th:text="${commentUsernamesMap[comment.commentId]}"></strong>: 
      <span th:text="${comment.content}"></span>
    </div>
  </div>
</div>

  <!-- Reel -->
<div th:if="${item.type == 'REEL'}" class="reel-post">
  <div class="post-header">
  <a href="#" th:attr="data-user-id=${reelUserMap[item.content.reelId].user_id}" class="profile-link">
    <img
      th:src="@{${reelUserMap[item.content.reelId].photo != null ? '/uploads/profile/' + reelUserMap[item.content.reelId].photo : '/default.png'}}"
      alt="User Photo"
      style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;"
    />
    <span th:text="${reelUserMap[item.content.reelId].user_name}" style="margin-left: 10px; font-weight: 600; cursor: pointer;"></span>
  </a>
</div>

  <!-- REEL PREVIEW VIDEO -->
  <div class="reel-video" style="margin-top: 10px; position: relative;">
    <a th:href="@{/reels/{id}(id=${item.content.reelId})}" style="display: block; position: relative;">
      <!-- Thumbnail preview (first frame or black fallback) -->
      <video
        th:src="@{'/uploads/' + ${#strings.substringAfter(item.content.videoFile, '/uploads/')}}"
        muted
        preload="metadata"
        playsinline
        style="width: 100%; height: auto; object-fit: cover; border-radius: 10px; background: #000;"
        poster="/default-thumbnail.jpg"
        onmouseover="this.play()"
        onmouseout="this.pause(); this.currentTime=0;"
      ></video>

      <!-- Play icon overlay -->
      <div style="
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 45px;
        opacity: 0.8;">
        <i class="fa-solid fa-play-circle"></i>
      </div>
    </a>
  </div>

  <div class="post-caption" th:if="${item.content.caption != null}" style="margin-top: 8px;">
    <span class="username" th:text="${reelUserMap[item.content.reelId].user_name}" style="font-weight: 600;"></span>
    <span th:text="${item.content.caption}" style="margin-left: 5px;"></span>
  </div>

  <div class="post-meta" style="margin-top: 5px; font-size: 13px; color: gray;">
    <span th:text="${reelLikesMap[item.content.reelId] != null ? reelLikesMap[item.content.reelId] + ' likes' : '0 likes'}"></span>
    <small style="margin-left: 10px;" th:text="${#dates.format(reelCreatedAtMap[item.content.reelId], 'dd MMM yyyy HH:mm')}"></small>
  </div>
  <!-- Comment popup trigger -->
<div class="view-comments" style="color: #555; font-size: 13px; cursor: pointer;"
     th:attr="data-reel-id=${item.content.reelId}">
  View comments (<span th:text="${reelCommentsMap[item.content.reelId]?.size() != null ? reelCommentsMap[item.content.reelId].size() : 0}">0</span>)
</div>

<!-- Comment popup -->
<div class="comments-popup" th:attr="id='comments-reel-' + ${item.content.reelId}" style="display:none; background:#f9f9f9; padding:8px; border-radius:6px; margin-top:5px;">
  <div th:each="comment : ${reelCommentsMap[item.content.reelId]}">
    <strong th:text="${commentUsernamesMap[comment.commentId]}"></strong>: 
    <span th:text="${comment.content}"></span>
  </div>
</div>
</div>
  
    <!-- Bottom Navbar (Mobile) -->
    <nav class="bottom-nav">
      <div class="nav-item active">
        <i class="fa-solid fa-house"></i>
        <span>Home</span>
      </div>
      <div class="nav-item" id="mobile-search-btn">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>Search</span>
      </div>
      <div class="nav-item">
        <i class="fa-solid fa-circle-plus"></i>
        <span>Create</span>
      </div>
      <div class="nav-item" data-link="/chat">
        <i class="fa-regular fa-comment"></i>
        <span>Messages</span>
      </div>
      <div class="nav-item" data-link="/profile">
        <i class="fa-regular fa-user"></i>
        <span>Profile</span>
      </div>
      <div class="nav-item" id="more-nav-mobile">
        <i class="fa-solid fa-bars more-btn"></i>
        <span>More</span>
      </div>
    </nav>
  </div>

  <!-- More Menu Popup -->

  <!-- Story Upload Modal -->
  <div class="story-upload-modal" id="storyUploadModal">
    <div class="story-upload-content">
      <div class="story-upload-header">
        <span class="close-btn" id="storyCloseBtn">&times;</span>
      </div>
      <form id="storyForm" th:action="@{/stories}" action="/stories" method="post" enctype="multipart/form-data">
        <div class="story-preview" id="storyPreview"></div>
        <input type="file" id="storyFile" name="storyFile" accept="image/*,video/*" style="display:none;">
        <input type="text" name="highlightTopic" placeholder="Add a caption (optional)">
        <div class="story-input">
          <button type="button" class="add-story-btn" id="addStoryBtn">Choose file</button>
          <button type="submit" class="post-story-btn">Post</button>
        </div>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}" />
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <!-- JavaScript -->
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();

      const storyUploadModal = document.querySelector('#storyUploadModal');
      storyUploadModal.style.display = 'none';
      initSearch();
      initMoreMenu();
    });


    function initModals() {
            // Open create modal
            if (createPostBtn) {
                createPostBtn.addEventListener('click', () => createModal.style.display = 'flex');
            }

            // Open upload modal
            if (postOption) {
                postOption.addEventListener('click', () => {
                    createModal.style.display = 'none';
                    uploadModal.style.display = 'flex';
                });
            }

            // Multi-image preview
            if (photoUpload) {
                photoUpload.addEventListener('change', (event) => {
                    const files = event.target.files;
                    previewContainer.innerHTML = '';
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = e => {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            previewContainer.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                });
            }

            // Close modals on outside click
            document.addEventListener('click', event => {
                if(event.target === createModal) createModal.style.display = 'none';
                if(event.target === uploadModal) {
                    uploadModal.style.display = 'none';
                    if (previewContainer) previewContainer.innerHTML = '';
                    if (photoUpload) photoUpload.value = '';
                }
            });
        }



    // Search functionality elements
    const searchBtn = document.getElementById('search-btn');
    const mobileSearchBtn = document.getElementById('mobile-search-btn');
    const searchPanel = document.getElementById('search-panel');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');

    // More menu elements
    const moreBtn = document.getElementById('more-nav');
    const menuPopup = document.getElementById('menu-popup');

    // Like and other interactive elements
    const likes = document.querySelectorAll('.like-btn');
    const navItems = document.querySelectorAll('.nav-item');
    const commentBtns = document.querySelectorAll('.comment-btn');
    const popups = document.querySelectorAll('.comment-popup');
    const closeBtns = document.querySelectorAll('.close-btn');
    const postMedias = document.querySelectorAll('.post-media');
    const storyFileInput = document.querySelector('#storyFile');
    const addStoryBtn = document.querySelector('#addStoryBtn');
    const storyPreview = document.querySelector('#storyPreview');
    const storyCloseBtn = document.querySelector('#storyCloseBtn');

    // Like button functionality
    likes.forEach(like => {
      like.addEventListener('click', () => {
        like.classList.toggle('liked');
        like.classList.toggle('fa-regular');
        like.classList.toggle('fa-solid');
        if (like.closest('form')) {
          like.closest('form').submit();
        }
      });
    });

    // Navigation active state
    navItems.forEach(item => {
      const link = item.getAttribute('data-link');
      item.addEventListener('click', () => {
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        if (link) window.location.href = link;
      });
    });

    // Carousel functionality
    postMedias.forEach(media => {
      const carousel = media.querySelector('.carousel');
      const slides = carousel.querySelectorAll('.carousel-slide');
      const prevBtn = media.querySelector('.prev');
      const nextBtn = media.querySelector('.next');
      const indicatorsContainer = media.querySelector('.carousel-indicators');

      if (slides.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        return;
      }

      slides.forEach((_, index) => {
        const dot = document.createElement('span');
        dot.classList.add('dot');
        if (index === 0) dot.classList.add('active');
        indicatorsContainer.appendChild(dot);
      });

      const dots = indicatorsContainer.querySelectorAll('.dot');
      let currentIndex = 0;

      function updateCarousel() {
        carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach((dot, idx) => dot.classList.toggle('active', idx === currentIndex));
        prevBtn.style.display = currentIndex === 0 ? 'none' : 'block';
        nextBtn.style.display = currentIndex === slides.length - 1 ? 'none' : 'block';
      }

      prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
          currentIndex--;
          updateCarousel();
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentIndex < slides.length - 1) {
          currentIndex++;
          updateCarousel();
        }
      });

      updateCarousel();
    });

    // Comment popup toggle
    commentBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        popups.forEach(popup => popup.classList.remove('active'));
        const popup = btn.closest('.post-actions').querySelector('.comment-popup');
        popup.classList.add('active');
        const rect = popup.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
          popup.style.right = 'auto';
          popup.style.left = '-360px';
        }
      });
    });

    closeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        btn.closest('.comment-popup').classList.remove('active');
      });
    });

    // Story upload functionality
    document.querySelectorAll('.story-add').forEach(btn => {
      btn.addEventListener('click', () => {
        storyUploadModal.style.display = 'flex';
      });
    });

    addStoryBtn.addEventListener('click', () => storyFileInput.click());

    storyFileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        storyPreview.innerHTML = `<${file.type.startsWith('image') ? 'img' : 'video'} src="${url}" class="story-preview-item" ${file.type.startsWith('video') ? 'controls' : ''}></${file.type.startsWith('image') ? 'img' : 'video'}>`;
      }
    });

    storyCloseBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      closeStoryModal();
    });

    window.addEventListener('click', (event) => {
      if (event.target === storyUploadModal) closeStoryModal();
    });

    function closeStoryModal() {
      storyUploadModal.style.display = 'none';
      storyPreview.innerHTML = '';
      storyFileInput.value = '';
    }

    // Story overlay logic
let allStories = [];
let userStories = /*[[${userStories}]]*/ [];
let currentUser = /*[[${currentUser}]]*/ {};

userStories.forEach(story => {
  allStories.push({
    storyId: story.storyId,
    mediaFile: story.mediaFile,
    userName: currentUser.user_name
  });
});

let followingStories = /*[[${followingStories}]]*/ [];
followingStories.forEach(story => {
  allStories.push({
    storyId: story[0], // storyId from index 0
    mediaFile: story[1], // mediaFile from index 2 (based on StoryDao query)
    userName: story[6] // user_name from index 6
  });
});

    let currentStoryIndex = 0;
    let currentUserStories = [];

    document.querySelectorAll('.story-item.has-story').forEach((storyDiv) => {
      const storyId = parseInt(storyDiv.getAttribute('data-story-id'));
      const userName = storyDiv.getAttribute('data-user-name');
      storyDiv.addEventListener('click', () => {
        // Filter stories for the clicked user's username
        currentUserStories = allStories.filter(s => s.userName === userName);
        const story = currentUserStories.find(s => s.storyId === storyId);
        if (story) {
          currentStoryIndex = currentUserStories.indexOf(story);
          showStory(currentStoryIndex);
          document.getElementById('storyOverlay').style.display = 'flex';
        }
      });
    });


    // --- Archive toggle functionality inside story modal ---
const toggleArchiveBtn = document.getElementById('toggleArchiveBtn');
let currentStory = null; // will store the active story object

function showStory(index) {
  const story = currentUserStories[index];
  currentStory = story; // store reference
  const storyImage = document.getElementById('storyImage');
  const storyVideo = document.getElementById('storyVideo');
  const storyUsername = document.getElementById('storyUsername');
  const overlay = document.getElementById('storyOverlay');

  if (!story || !story.mediaFile) {
    overlay.style.display = 'none';
    return;
  }

  storyUsername.textContent = story.userName;
  overlay.style.display = 'flex';

   // ‚úÖ Ensure full URL for media
  const mediaUrl = story.mediaFile.startsWith('/uploads/')
    ? story.mediaFile
    : '/uploads/' + story.mediaFile;

if (story.mediaFile.toLowerCase().endsWith('.mp4')) {
  storyVideo.src = mediaUrl;
  storyVideo.style.display = 'block';
  storyImage.style.display = 'none';
  storyVideo.load(); // Important for video
  storyVideo.play().catch(() => {});
} else {
  storyImage.src = mediaUrl;
  storyImage.style.display = 'block';
  storyVideo.style.display = 'none';
  storyVideo.pause();
  storyVideo.src = '';
}


  // ‚úÖ Update button label based on current archive status
  fetch(`/stories/status/${story.storyId}`)
    .then(r => r.json())
    .then(data => {
      toggleArchiveBtn.textContent = data.isArchived ? 'Unarchive' : 'Archive';
      toggleArchiveBtn.dataset.archived = data.isArchived;
    })
    .catch(() => {
      toggleArchiveBtn.textContent = 'Archive';
      toggleArchiveBtn.dataset.archived = 'false';
    });

    // ‚úÖ Update like count
  updateStoryLikeCount(story.storyId);
}

// ‚úÖ Toggle archive/unarchive
toggleArchiveBtn.addEventListener('click', () => {
  if (!currentStory) return;
  const newArchivedStatus = toggleArchiveBtn.dataset.archived === 'true' ? false : true;

fetch('/stories/archive', {
  method: 'POST',
  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
  body: `storyId=${currentStory.storyId}&archived=${newArchivedStatus}`
})
  .then(response => response.text())
  .then(msg => {
    console.log(msg);
    toggleArchiveBtn.textContent = newArchivedStatus ? 'Unarchive' : 'Archive';
    toggleArchiveBtn.dataset.archived = newArchivedStatus;
  })
  .catch(err => console.error('Archive toggle error:', err));

});







// --- Story Like button setup ---
const storyLikeBtn = document.getElementById('storyLikeBtn');
const storyLikeCount = document.getElementById('storyLikeCount');

// ‚úÖ Update like count when story opens
function updateStoryLikeCount(storyId) {
  fetch(`/like/story/${storyId}/count`)
    .then(r => r.text())
    .then(count => {
      storyLikeCount.textContent = count;
    })
    .catch(err => console.error('Error fetching like count:', err));
}




// ‚úÖ Handle like button click
storyLikeBtn.addEventListener('click', () => {
  if (!currentStory) return;
  fetch('/like/story/toggle', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `contentId=${currentStory.storyId}`
  })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        alert('Please login to like stories!');
        return;
      }
      storyLikeCount.textContent = data.likeCount;
      storyLikeBtn.textContent = data.liked
        ? `‚ù§Ô∏è Liked (${data.likeCount})`
        : `ü§ç Like (${data.likeCount})`;
    })
    .catch(err => console.error('Like toggle error:', err));
});

  // ‚úÖ Open the comment modal
document.getElementById("storyCommentBtn").addEventListener("click", () => {
  const modal = document.getElementById("storyCommentModal");
  modal.style.display = modal.style.display === "none" ? "block" : "none";
});

// ‚úÖ Submit comment on "Post" button click
document.getElementById("storySubmitCommentBtn").addEventListener("click", () => {
  const text = document.getElementById("storyCommentText").value.trim();
  if (!text) return alert("Please enter a comment!");

  fetch("/comment/story/add", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `contentId=${currentStory.storyId}&text=${encodeURIComponent(text)}`
  })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        alert("Please login to comment!");
        return;
      }

      // Dynamically append comment
      const commentList = document.createElement("div");
      commentList.innerHTML = `<b>${data.username}:</b> ${data.content}`;
      document.getElementById("storyCommentModal").appendChild(commentList);

      document.getElementById("storyCommentText").value = "";
    })
    .catch(err => console.error("Comment add error:", err));
});






    document.getElementById('storyNext').addEventListener('click', () => {
      if (currentUserStories.length > 0) {
        currentStoryIndex = (currentStoryIndex + 1) % currentUserStories.length;
        showStory(currentStoryIndex);
      }
    });

    document.getElementById('storyPrev').addEventListener('click', () => {
      if (currentUserStories.length > 0) {
        currentStoryIndex = (currentStoryIndex - 1 + currentUserStories.length) % currentUserStories.length;
        showStory(currentStoryIndex);
      }
    });

    document.getElementById('closeStoryOverlay').addEventListener('click', () => {
      const overlay = document.getElementById('storyOverlay');
      overlay.style.display = 'none';
      const storyVideo = document.getElementById('storyVideo');
      storyVideo.pause();
      storyVideo.src = '';
    });

    // Search functionality
    function initSearch() {
      if (searchBtn) {
        searchBtn.addEventListener('click', () => toggleSearchPanel());
      }
      if (mobileSearchBtn) {
        mobileSearchBtn.addEventListener('click', () => toggleSearchPanel());
      }

      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const query = searchInput.value.trim();
        if (query === "") {
          searchResults.innerHTML = "";
          return;
        }
        searchTimeout = setTimeout(() => performSearch(query), 300);
      });

      document.addEventListener('click', (event) => {
        if (!searchPanel.contains(event.target) && !searchBtn?.contains(event.target) && !mobileSearchBtn?.contains(event.target)) {
          closeSearchPanel();
        }
      });
    }

    function toggleSearchPanel() {
      searchPanel.style.display = searchPanel.style.display === 'flex' ? 'none' : 'flex';
      document.body.classList.toggle('search-open');
      if (searchPanel.style.display === 'flex') searchInput.focus();
    }

    function closeSearchPanel() {
      searchPanel.style.display = 'none';
      document.body.classList.remove('search-open');
    }

    function performSearch(query) {
      searchResults.innerHTML = "<div style='padding: 10px; text-align: center; color: #8e8e8e;'>Searching...</div>";
      query = query.trim();
      if (query.startsWith("#")) {
        const hashtagText = query.substring(1); // remove #
        if (hashtagText.length === 0) {
          searchResults.innerHTML = "<div style='padding: 10px; text-align: center; color: #8e8e8e;'>Type something after #</div>";
          return;
        }
        searchHashtags(hashtagText);
      } else {
        searchUsers(query);
      }
    }

    function searchUsers(query)
    {
      fetch(`/search/users?q=${encodeURIComponent(query)}`)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => displaySearchResults(data))
        .catch(error => {
          console.error('Search error:', error);
          searchResults.innerHTML = `
            <div style='padding: 10px; text-align: center; color: #8e8e8e;'>
              Error searching users. Please try again.
            </div>
          `;
        });
    }

    function displaySearchResults(users) {
      searchResults.innerHTML = "";
      if (!users || users.length === 0) {
        searchResults.innerHTML = "<div style='padding: 10px; text-align: center; color: #8e8e8e;'>No users found</div>";
        return;
      }

      users.forEach(user => {
        const resultDiv = document.createElement("div");
        resultDiv.className = "search-result";
        const profilePicUrl = user.photo ? `/uploads/profile/${user.photo}` : '/uploads/default_dp.jpg';

        resultDiv.innerHTML = `
          <img src="${profilePicUrl}" alt="${user.user_name}" onerror="this.src='/uploads/default_dp.jpg'">
          <div>
            <strong>${user.user_name}</strong>
            <div style="font-size: 12px; color: #8e8e8e;">
              ${user.first_name} ${user.last_name}
            </div>
          </div>
        `;
        // Redirect to user profile when clicked
resultDiv.addEventListener('click', () => {
    fetch(`/follow/status/${user.user_id}`)
        .then(response => response.json())
        .then(data => {
            // data should contain: { isFollowing: true/false, privacy: "PUBLIC"/"PRIVATE" }
            if (data.privacy === "PUBLIC") {
                // Public account ‚Üí always go to profile
                window.location.href = `/profile/${user.user_id}`;
            } else {
                // Private account ‚Üí only go to profile if following
                if (data.isFollowing) {
                    window.location.href = `/profile/${user.user_id}`;
                } else {
                    // Private and not followed ‚Üí user page
                    window.location.href = `/user/${user.user_id}`;
                }
            }
        })
        .catch(error => {
            console.error("Error checking follow status:", error);
            // fallback: go to user page
            window.location.href = `/user/${user.user_id}`;
        });
});

            
            searchResults.appendChild(resultDiv);
        });
    }

    function searchHashtags(hashtagText) {
      fetch(`/search/hashtags?q=${encodeURIComponent(hashtagText)}`)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => displayHashtagResults(data))
        .catch(error => {
          console.error('Search error (hashtags):', error);
          searchResults.innerHTML = `
            <div style='padding: 10px; text-align: center; color: #8e8e8e;'>
              Error searching hashtags. Please try again.
            </div>`;
        });
    }

    function displayHashtagResults(hashtags) {
      searchResults.innerHTML = "";
      if (!hashtags || hashtags.length === 0) {
        searchResults.innerHTML = "<div style='padding: 10px; text-align: center; color: #8e8e8e;'>No hashtags found</div>";
        return;
      }

      hashtags.forEach(tag => {
        const resultDiv = document.createElement("div");
        resultDiv.className = "search-result";
        resultDiv.innerHTML = `
          <div style="padding: 8px;">
            <strong>#${tag.text}</strong>
            <div style="font-size: 12px; color: #8e8e8e;">
              ${tag.post_count} post${tag.post_count === 1 ? '' : 's'}
            </div>
          </div>
        `;
        // Redirect to hashtag page when clicked
        resultDiv.addEventListener('click', () => {
          window.location.href = `/hashtag/${tag.text}`;
        });

        searchResults.appendChild(resultDiv);
      });
    }

    // More menu functionality
    function initMoreMenu() {
      if (moreBtn) {
        moreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          menuPopup.classList.toggle('active');
        });
      }
      document.addEventListener('click', () => menuPopup.classList.remove('active'));
    }
    document.querySelectorAll('.view-comments').forEach(btn => {
  btn.addEventListener('click', () => {
    const postId = btn.getAttribute('data-post-id');
    const reelId = btn.getAttribute('data-reel-id');
    let popup;
    if (postId) {
      popup = document.getElementById('comments-post-' + postId);
    } else if (reelId) {
      popup = document.getElementById('comments-reel-' + reelId);
    }
    if (popup) {
      popup.style.display = popup.style.display === 'none' ? 'block' : 'none';
    }
  });
})

document.querySelectorAll('.profile-link').forEach(link => {
  link.addEventListener('click', (event) => {
    event.preventDefault();

    const userId = link.getAttribute('data-user-id');
    if (!userId) return;

    // Check if the clicked profile belongs to the logged-in user
    if (parseInt(userId) === currentUser.user_id) {
      window.location.href = `/profile`;
      return;
    }

    // Otherwise, check follow/visibility status
    fetch(`/follow/status/${userId}`)
      .then(response => response.json())
      .then(data => {
        if (data.privacy === "PUBLIC" || data.isFollowing) {
          window.location.href = `/profile/${userId}`;
        } else {
          window.location.href = `/user/${userId}`;
        }
      })
      .catch(error => {
        console.error("Error checking follow status:", error);
        window.location.href = `/user/${userId}`;
      });
  });
});








// Theme functionality
// Theme functionality
function initializeTheme() {
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    
    // Get current theme from the data-theme attribute on body/html element
    const currentTheme = document.documentElement.getAttribute('data-theme') || 
                        document.body.getAttribute('data-theme') || 
                        'light';

    console.log('Home page - Current theme on load:', currentTheme);

    // Initialize theme UI
    applyTheme(currentTheme);

    // Theme toggle event
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            console.log('Home page - Theme changing to:', newTheme);
            
            // Update UI immediately
            applyTheme(newTheme);
            
            // Save to server immediately
            saveThemePreference(newTheme);
        });
    }
}

function applyTheme(theme) {
    // Apply theme to document
    document.documentElement.setAttribute('data-theme', theme);
    document.body.setAttribute('data-theme', theme);
    
    // Update theme icon
    updateThemeIcon(theme);
}

function updateThemeIcon(theme) {
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        if (theme === 'dark') {
            themeIcon.className = 'fa-solid fa-moon';
        } else {
            themeIcon.className = 'fa-solid fa-sun';
        }
    }
}

function saveThemePreference(theme) {
    fetch('/settings/updateTheme', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `theme=${theme}`
    })
    .then(response => response.text())
    .then(data => {
        if (data !== 'SUCCESS') {
            console.error('Home page - Failed to save theme preference');
        } else {
            console.log('Home page - Theme saved successfully:', theme);
        }
    })
    .catch(error => {
        console.error('Home page - Error saving theme:', error);
    });
}

// // Initialize theme when DOM is loaded
// document.addEventListener('DOMContentLoaded', initializeTheme);
  </script>
</body>
</html>