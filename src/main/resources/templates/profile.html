<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaShare Profile</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background-color: #fafafa; color: #262626; }
        .navbar { background-color: #fff; border-bottom: 1px solid #dbdbdb; padding: 10px 20px; position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .navbar-title { font-size: 24px; font-weight: 600; }
        .navbar-icons { display: flex; gap: 20px; font-size: 24px; }
        .sidebar { background-color: #fff; border-right: 1px solid #dbdbdb; width: 70px; height: 100vh; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; align-items: center; padding-top: 70px; z-index: 999; }
        .sidebar-item { font-size: 24px; margin: 20px 0; cursor: pointer; }
        
        /* Search Panel Styles */
        .search-panel {
            position: fixed;
            top: 0;
            left: 70px; /* right next to sidebar */
            width: 300px;
            height: 100vh;
            background-color: #fff;
            border-right: 1px solid #dbdbdb;
            z-index: 998;
            display: none;
            flex-direction: column;
            padding: 70px 15px 15px;
        }

        .search-panel input {
            width: 100%;
            padding: 10px;
            border: 1px solid #dbdbdb;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
        }

        .search-result {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-result:hover {
            background-color: #fafafa;
        }

        .search-result img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .search-result span {
            font-size: 14px;
            font-weight: 500;
        }
        
        .container { 
            max-width: 935px; 
            margin: 0 auto; 
            padding: 20px; 
            margin-left: 90px; 
            margin-top: 60px; 
            transition: margin-left 0.3s ease;
        }
        
        .container.with-search { 
            margin-left: calc(90px + 300px); /* sidebar + search panel */
        }

        .profile-header { display: flex; align-items: center; margin-bottom: 44px; padding: 20px 0; }
        .profile-pic { width: 150px; height: 150px; border-radius: 50%; margin-right: 100px; overflow: hidden; }
        .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        .profile-info { flex: 1; }
        .username-section { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .username { font-size: 28px; font-weight: 300; }
        .profile-stats { display: flex; margin-bottom: 20px; }
        .stat { margin-right: 40px; font-size: 16px; }
        .stat span { font-weight: 600; }
        .bio { font-size: 16px; line-height: 24px; }
        .posts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 28px; }
        .post { width: 100%; padding-top: 100%; position: relative; background-color: #fff; border: 1px solid #dbdbdb; }
        .post img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* Follow Button Styles */
        .follow-btn, .unfollow-btn, .requested-btn, .edit-profile-btn {
            padding: 8px 24px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }
        
        .follow-btn {
            background-color: #0095f6;
            color: white;
        }
        
        .unfollow-btn {
            background-color: transparent;
            border: 1px solid #dbdbdb;
            color: #262626;
        }
        
        .requested-btn {
            background-color: transparent;
            border: 1px solid #dbdbdb;
            color: #262626;
        }
        
        .edit-profile-btn {
            background-color: transparent;
            border: 1px solid #dbdbdb;
            color: #262626;
        }
        
        .follow-btn:hover {
            background-color: #0074cc;
        }
        
        .unfollow-btn:hover {
            background-color: #fafafa;
        }
        
        .edit-profile-btn:hover {
            background-color: #fafafa;
        }
        
        .profile-actions {
            display: flex;
            gap: 10px;
        }
        
        .follow-requests-link {
            margin-top: 10px;
        }
        
        .follow-requests-link a {
            color: #0095f6;
            text-decoration: none;
            font-size: 14px;
        }
        
        .follow-requests-link a:hover {
            text-decoration: underline;
        }

        .modal, .upload-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; border-radius: 12px; padding: 20px; width: 300px; text-align: center; }
        .modal-option { padding: 10px; font-size: 16px; cursor: pointer; border-bottom: 1px solid #dbdbdb; }
        .modal-option:last-child { border-bottom: none; }
        .modal-option:hover { background-color: #fafafa; }
        .upload-modal-content { background-color: #fff; border-radius: 12px; width: 600px; height: 400px; display: flex; overflow: hidden; }
        .upload-preview { width: 50%; background-color: #fafafa; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 5px; overflow-y: auto; }
        .upload-preview img { max-width: 100%; max-height: 100px; object-fit: contain; }
        .upload-caption { width: 50%; padding: 20px; display: flex; flex-direction: column; }
        .upload-caption textarea { flex: 1; border: 1px solid #dbdbdb; border-radius: 4px; padding: 10px; resize: none; font-size: 14px; }
        .upload-caption button { margin-top: 10px; padding: 8px; background-color: #0095f6; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .upload-caption button:hover { background-color: #0074cc; }
        
        @media (max-width: 768px) {
            .sidebar { width: 50px; padding-top: 60px; }
            .sidebar-item { font-size: 20px; margin: 15px 0; }
            .container { margin-left: 60px; margin-top: 50px; padding: 10px; }
            .container.with-search { margin-left: 60px; }
            .profile-header { flex-direction: column; align-items: flex-start; }
            .profile-pic { margin: 0 auto 20px; width: 100px; height: 100px; }
            .posts-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .upload-modal-content { width: 90%; height: 80%; flex-direction: column; }
            .upload-preview { width: 100%; height: 50%; }
            .upload-caption { width: 100%; height: 50%; }
            .username-section { flex-direction: column; align-items: flex-start; gap: 10px; }
            .profile-actions { width: 100%; }
            .follow-btn, .unfollow-btn, .requested-btn, .edit-profile-btn { width: 100%; }
            
            /* Search panel mobile styles */
            .search-panel {
                left: 50px;
                width: 250px;
            }
        }
        .flash-message { color: green; text-align: center; margin-bottom: 10px; }

        .reel-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 8px; /* reduced spacing between reels */
    margin-top: 10px;
}

.reel-item {
    position: relative;
    overflow: hidden;
    border-radius: 10px;
    background: #000;
    aspect-ratio: 9 / 16; /* ensures no white space */
    cursor: pointer;
}

.reel-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
}

.reel-item:hover video {
    transform: scale(1.05);
}

    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-title">MediaShare</div>
        <div class="navbar-icons">
            <span>‚ù§Ô∏è</span>
            <span>üîÅ</span>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-item"><a th:href="@{/dashboard}" style="text-decoration: none; color: inherit;">üè†</a></div>
        <div class="sidebar-item" id="search-btn">üîç</div>
        <div class="sidebar-item" id="create-post">‚ûï</div>
        <div class="sidebar-item"><a th:href="@{/chat}" style="text-decoration: none; color: inherit;">üí¨</a></div>
        <div class="sidebar-item"><a th:href="@{/profile}" style="text-decoration: none; color: inherit;">üë§</a></div>
        <div class="sidebar-item"><a th:href="@{/settings}" style="text-decoration: none; color: inherit;">‚â°</a></div>
    </div>

    <!-- Search Panel -->
    <div class="search-panel" id="search-panel">
        <input type="text" id="search-input" placeholder="Search usernames...">
        <div class="search-results" id="search-results"></div>
    </div>

    <!-- Main Container -->
    <div class="container" id="main-container">
        <!-- Flash Message -->
        <div th:if="${message}" class="flash-message" th:text="${message}"></div>

        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-pic">
                <img th:src="${user.photo != null} ? @{/uploads/{file}(file=${user.photo})} : @{/uploads/default_dp.jpg}" alt="Profile Picture">
            </div>
            <div class="profile-info">
                <div class="username-section">
                    <div class="username" th:text="${user.user_name}">username</div>
                    <div class="profile-actions" th:if="${currentUser != null}">
                        <!-- Edit Profile Button (own profile) -->
                        <button class="edit-profile-btn" 
                                th:if="${currentUser.user_id == user.user_id}"
                                onclick="location.href='/settings'">
                            Edit Profile
                        </button>
                        
                        <!-- Follow/Unfollow Buttons (other users) -->
                        <button class="follow-btn" id="followBtn" onclick="followUser()" 
                                th:if="${currentUser.user_id != user.user_id}" 
                                style="display: none;">
                            Follow
                        </button>
                        <button class="unfollow-btn" id="unfollowBtn" onclick="unfollowUser()" 
                                th:if="${currentUser.user_id != user.user_id}" 
                                style="display: none;">
                            Following
                        </button>
                        <button class="requested-btn" id="requestedBtn" 
                                th:if="${currentUser.user_id != user.user_id}" 
                                style="display: none;">
                            Requested
                        </button>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="stat"><span th:text="${postCount}">0</span> posts</div>
                    <div class="stat">
                        <span id="followerCount" th:text="${followers != null ? followers : 0}">0</span> 
                        <a th:href="@{/followers/{id}(id=${user.user_id})}" style="text-decoration: none; color: inherit;">followers</a>
                    </div>
                    <div class="stat">
                        <span id="followingCount" th:text="${following != null ? following : 0}">0</span> 
                        <a th:href="@{/following/{id}(id=${user.user_id})}" style="text-decoration: none; color: inherit;">following</a>
                    </div>
                </div>
                
                <div class="bio">
                    <strong th:text="${user.first_name + ' ' + user.last_name}">Full Name</strong>
                    <p th:text="${user.bio}">A short bio</p>
                </div>
                
                <!-- Follow Requests Link (only show for own profile if private account) -->
                <div class="follow-requests-link" 
                    th:if="${currentUser != null && currentUser.user_id == user.user_id && user.privacy != null && user.privacy.name() == 'PRIVATE'}">
                    <a th:href="@{/follow/requests}">View follow requests</a>
                </div>
            </div>
        </div>

        <!-- Posts Grid -->
        <div class="posts-grid">
            <div class="post" th:each="post : ${posts}">
                <a th:href="@{/post/{id}(id=${post.postId})}">
                    <div th:each="media : ${postMediaMap[post.postId]}">
                        <img th:if="${media.type.name() == 'PHOTO'}"
                            th:src="@{${media.url}}"
                            th:alt="${post.caption}" />
                    </div>
                </a>
            </div>
        </div>

        <!-- Reels Grid -->
        <!-- <h2 style="margin: 20px 0; font-size: 20px;">Reels</h2>
        <div class="posts-grid">
            <div class="post" th:each="reel : ${reels}">
                <a th:href="@{/reels/{id}(id=${reel.reelId})}">
                <video th:src="@{'/uploads/' + ${#strings.substringAfter(reel.videoFile, '/uploads/')}}"
       preload="metadata"
       muted
       loop
       style="width:100%; height:100%; object-fit:cover;"
       onloadedmetadata="this.currentTime=1">
</video>

                <div th:text="${reel.caption}" style="padding:5px; font-size:14px;"></div>
            </div>
        </div> -->

        <!-- Reels Section -->
<h2>Reels</h2>
<div class="reel-grid">
    <div class="reel-item" th:each="reel : ${reels}">
        <a th:href="@{'/reels/' + ${reel.reelId}}">
            <video
                th:src="@{'/uploads/' + ${#strings.substringAfter(reel.videoFile, '/uploads/')}}"
                muted
                playsinline
                preload="metadata"
                poster=""
                style="width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 10px;"
                onmouseover="this.play()"
                onmouseout="this.pause(); this.currentTime=0;"
            ></video>
        </a>
    </div>
</div>


    <!-- Create Modal -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="modal-option" id="post-option">Post</div>
            <div class="modal-option">Story</div>
            <div class="modal-option">Reel</div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="upload-modal" id="upload-modal">
        <div class="upload-modal-content">
            <div class="upload-preview" id="preview-container"></div>
            <div class="upload-caption">
                <form th:action="@{/posts}" method="post" enctype="multipart/form-data">
                    <input type="file" name="mediaFiles" id="photo-upload" accept="image/*" multiple required style="margin-bottom:10px;">
                    <textarea name="caption" placeholder="Write a caption..." required></textarea>
                    <button type="submit">Share</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Reel Upload Modal -->
<div class="upload-modal" id="reel-upload-modal">
    <div class="upload-modal-content">
        <div class="upload-preview" id="reel-preview-container"></div>
        <div class="upload-caption">
            <form th:action="@{/reels}" method="post" enctype="multipart/form-data">
                <input type="file" name="videoFile" id="video-upload" accept="video/*" required style="margin-bottom:10px;">
                <textarea name="caption" placeholder="Write a caption..."></textarea>
                <button type="submit">Share Reel</button>
            </form>
        </div>
    </div>
</div>


    <!-- Scripts -->
    <script>
        const createPostBtn = document.getElementById('create-post');
        const createModal = document.getElementById('create-modal');
        const postOption = document.getElementById('post-option');
        const uploadModal = document.getElementById('upload-modal');
        const photoUpload = document.getElementById('photo-upload');
        const previewContainer = document.getElementById('preview-container');
        const reelOption = document.querySelector(".modal-option:nth-child(3)"); 
        const reelUploadModal = document.getElementById('reel-upload-modal');
        const videoUpload = document.getElementById('video-upload');    
        const reelPreviewContainer = document.getElementById('reel-preview-container');

        // Search functionality elements
        const searchBtn = document.getElementById('search-btn');
        const searchPanel = document.getElementById('search-panel');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const mainContainer = document.getElementById('main-container');

        // Follow/Unfollow functionality
        const userId = [[${user.user_id}]];
        const currentUserId = [[${currentUser != null ? currentUser.user_id : null}]];
        const isOwnProfile = [[${currentUser != null && currentUser.user_id == user.user_id}]];

        // Load follow status when page loads (only for other users' profiles)
        document.addEventListener('DOMContentLoaded', function() {
            if (currentUserId && !isOwnProfile) {
                loadFollowStatus();
            }

            // Open upload modal
            postOption.addEventListener('click', () => {
                createModal.style.display = 'none';
                uploadModal.style.display = 'flex';
            });

            // Initialize search functionality
            initSearch();
        });

        // Search functionality
    function initSearch() {
        // Toggle search panel
        searchBtn.addEventListener('click', () => {
            if (searchPanel.style.display === "flex") {
                searchPanel.style.display = "none";
                mainContainer.classList.remove("with-search");
            } else {
                searchPanel.style.display = "flex";
                mainContainer.classList.add("with-search");
                searchInput.focus();
            }
        });

        // Debounce search to avoid too many requests
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = searchInput.value.trim();
            
            if (query === "") {
                searchResults.innerHTML = "";
                return;
            }
            
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });

        // Close search panel when clicking outside
        document.addEventListener('click', (event) => {
            if (!searchPanel.contains(event.target) && !searchBtn.contains(event.target)) {
                searchPanel.style.display = "none";
                mainContainer.classList.remove("with-search");
            }
        });
    }

    function performSearch(query) {
        searchResults.innerHTML = "<div style='padding: 10px; text-align: center; color: #8e8e8e;'>Searching...</div>";
        
        fetch(`/search/users?q=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displaySearchResults(data);
            })
            .catch(error => {
                console.error('Search error:', error);
                searchResults.innerHTML = `
                    <div style='padding: 10px; text-align: center; color: #8e8e8e;'>
                        Error searching users. Please try again.
                    </div>
                `;
            });
    }

    function displaySearchResults(users) {
        searchResults.innerHTML = "";
        
        if (!users || users.length === 0) {
            searchResults.innerHTML = "<div style='padding: 10px; text-align: center; color: #8e8e8e;'>No users found</div>";
            return;
        }
        
        users.forEach(user => {
            const resultDiv = document.createElement("div");
            resultDiv.className = "search-result";
            
            const profilePicUrl = user.photo ? 
                `/uploads/${user.photo}` : 
                '/uploads/default_dp.jpg';
            
            resultDiv.innerHTML = `
                <img src="${profilePicUrl}" alt="${user.user_name}" 
                    onerror="this.src='/uploads/default_dp.jpg'">
                <div>
                    <strong>${user.user_name}</strong>
                    <div style="font-size: 12px; color: #8e8e8e;">
                        ${user.first_name} ${user.last_name}
                    </div>
                </div>
            `;
            
            resultDiv.addEventListener('click', () => {
                window.location.href = `/user/${user.user_id}`;
            });
            
            searchResults.appendChild(resultDiv);
        });
    }

        // Open reel modal
        reelOption.addEventListener('click', () => {
            createModal.style.display = 'none';
            reelUploadModal.style.display = 'flex';
        });

        // Multi-image preview
        photoUpload.addEventListener('change', (event) => {
            const files = event.target.files;
            previewContainer.innerHTML = '';
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        // Reel preview
        videoUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            reelPreviewContainer.innerHTML = '';
            if (file) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.width = 250;
                reelPreviewContainer.appendChild(video);
            }
        });

        // Close modals on outside click
        document.addEventListener('click', event => {
            if(event.target === createModal) createModal.style.display = 'none';
            if(event.target === uploadModal) {
                uploadModal.style.display = 'none';
                previewContainer.innerHTML = '';
                photoUpload.value = '';
            }
            
            // Initialize modals
            initModals();
        });

        function loadFollowStatus() {
            fetch('/follow/status/' + userId)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateFollowButtons(data.isFollowing, data.hasPendingRequest);
                        document.getElementById('followerCount').textContent = data.followerCount;
                        document.getElementById('followingCount').textContent = data.followingCount;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function updateFollowButtons(isFollowing, hasPendingRequest) {
            const followBtn = document.getElementById('followBtn');
            const unfollowBtn = document.getElementById('unfollowBtn');
            const requestedBtn = document.getElementById('requestedBtn');

            followBtn.style.display = 'none';
            unfollowBtn.style.display = 'none';
            requestedBtn.style.display = 'none';

            if (hasPendingRequest) {
                requestedBtn.style.display = 'block';
            } else if (isFollowing) {
                unfollowBtn.style.display = 'block';
            } else {
                followBtn.style.display = 'block';
            }
        }

        function followUser() {
            fetch('/follow/' + userId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateFollowButtons(data.isFollowing, data.hasPendingRequest);
                    document.getElementById('followerCount').textContent = data.followerCount;
                    // Show success message
                    showFlashMessage(data.message, 'success');
                } else {
                    showFlashMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showFlashMessage('Error following user', 'error');
            });
        }

        function unfollowUser() {
            if (confirm('Are you sure you want to unfollow this user?')) {
                fetch('/follow/unfollow/' + userId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateFollowButtons(data.isFollowing, data.hasPendingRequest);
                        document.getElementById('followerCount').textContent = data.followerCount;
                        showFlashMessage(data.message, 'success');
                    } else {
                        showFlashMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showFlashMessage('Error unfollowing user', 'error');
                });
            }
        }

        function showFlashMessage(message, type) {
            // Create flash message element
            const flashDiv = document.createElement('div');
            flashDiv.className = 'flash-message';
            flashDiv.style.color = type === 'success' ? 'green' : 'red';
            flashDiv.textContent = message;
            
            // Insert at top of container
            const container = document.querySelector('.container');
            container.insertBefore(flashDiv, container.firstChild);
            
            // Remove after 3 seconds
            setTimeout(() => {
                flashDiv.remove();
            }, 3000);
        }

        // Modal functionality
        function initModals() {
            // Open create modal
            if (createPostBtn) {
                createPostBtn.addEventListener('click', () => createModal.style.display = 'flex');
            }

            // Open upload modal
            if (postOption) {
                postOption.addEventListener('click', () => {
                    createModal.style.display = 'none';
                    uploadModal.style.display = 'flex';
                });
            }

            // Multi-image preview
            if (photoUpload) {
                photoUpload.addEventListener('change', (event) => {
                    const files = event.target.files;
                    previewContainer.innerHTML = '';
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = e => {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            previewContainer.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                });
            }

            // Close modals on outside click
            document.addEventListener('click', event => {
                if(event.target === createModal) createModal.style.display = 'none';
                if(event.target === uploadModal) {
                    uploadModal.style.display = 'none';
                    if (previewContainer) previewContainer.innerHTML = '';
                    if (photoUpload) photoUpload.value = '';
                }
            });
        }

        // Close reel modal
        document.addEventListener('click', event => {
            if(event.target === reelUploadModal) {
                reelUploadModal.style.display = 'none';
                reelPreviewContainer.innerHTML = '';
                videoUpload.value = '';
            }
        });
    </script>
</body>
</html>