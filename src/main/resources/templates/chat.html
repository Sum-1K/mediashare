<!DOCTYPE html>
<!-- {% load static %} -->
<html xmlns:th="http://www.thymeleaf.org"></html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/chat.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Oxygen:wght@300;400;700&family=Quicksand:wght@300..700&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>


</head>
<body>
    
    <nav class="bottom-nav">
    <div class="nav-item">
      <i class="fa-solid fa-house active"></i>
      <span>Home</span>
    </div>
    <div class="nav-item">
      <i class="fa-solid fa-magnifying-glass"></i>
      <span>Search</span>
    </div>

    <div class="nav-item">
      <i class="fa-solid fa-circle-plus"></i>
      <span>Create</span>
    </div>

    <div class="nav-item" data-link="/chat">
      <i class="fa-regular fa-comment" ></i>
      <span>Messages</span>
    </div>

    <div class="nav-item" data-link="/profile">
      <i class="fa-regular fa-user"></i>
      <span>Profile</span>
    </div>


    <div class="nav-item" id="more-nav">
      <i class="fa-solid fa-bars more-btn"></i>
      <span>More</span>
    </div>

    <div class="menu-popup">
      <a href="/settings" class="menu-item">Settings</a>
      <div class="menu-item">Your activity</div>
      <div class="menu-item">Saved</div>
      <div class="menu-item">Switch appearance</div>
      <div class="menu-item">Report a problem</div>
      <div class="menu-item">Switch accounts</div>
      <div class="menu-item">Log out</div>
    </div>
    
  </nav>
  


    <div class="container">
        <!-- Sidebar with Lessons -->
        <div class="sidebar">
            <h3>Chats</h3>

            <div class="search-container">
            <form method="post" action="{% url 'discussion' course_id=course.course_id %}" class="search-box"> 
                <div class="search-icon">
                <i class="fa-solid fa-magnifying-glass"></i>
                </div>
            <input type="text" id="userSearch" placeholder="Search users...">
            </form>
            <div id="searchResults" class="search-results"></div>
            </div>
            <ul id="chatUserList"> 
            </ul>
        </div>

        <div class="content">
            <div class="discussion_forum">
                <div class="heading">
                <h1>Messages</h1>
                <h4></h4>
                </div>
            
            
                <div id="chat-container">
                    <div class="chat-header" >
                        <div class="profile-photo-mini">
                            <img th:src="${chatUser != null ? chatUser.photo ?: '/shifu.jpg' : '/shifu.jpg'}" alt="Profile Picture">

                            <i class="fas fa-user"></i> <!-- Font Awesome user icon -->
                           
                        </div>
                        <h3 th:if="${chatUser != null}" th:text="${chatUser.user_name}"></h3>
                    </div>
                    <div class="messages">
                      <div th:each="msg : ${messages}" >
                        <div class="media-body">
                          <small class="text-muted" th:text="${#dates.format(msg.sent_at, 'HH:mm')}"></small>
                          <p class="article-content" th:text="${msg.message}"></p>
                        </div>
                      </div>
                    </div>
                <!--<article class="content-section">
                   
                        <div class="media-body">
                            <div class="article-metadata">
                                
                                <small class="text-muted">21:09</small>
                                <small class="text-muted">
                                    Replied to: Hi Master Shifu, nice profile pic! 
                                </small>
                            </div>
                            <p class="article-content">Haha thanks</p>
                        </div>
                    </article>
                 -->
            
                <div id="replyBox" style="display:none; padding: 5px 10px; background:#f0f0f0; border-left: 3px solid #007bff; margin-bottom:5px; font-size:0.9em;">
                <!-- Filled dynamically -->
                </div>
                <form id="chatForm" class="typing-box"> 
                    <input type="text" id="messageInput" placeholder="Type your message...">
                    <input type="file" id="mediaInput" accept="image/*,video/*" />
                    <button type="submit" class="btn btn-primary">Send</button>
                </form> 
            </div>
            </div>
        </div>
    </div>

    <!-- Media Viewer Modal -->
<!-- Fullscreen Media Modal -->
<div id="mediaModal" class="modal" style="display: none;">
  <span class="close">&times;</span>
  <img id="modalImage" style="display: none;" />
  <video id="modalVideo" controls style="display: none;"></video>
</div>


    
</body>
</html>



<!-- <script>
  // Menu toggle
  let CURRENT_CHAT_USER_ID = null;

  document.querySelector('.more-btn').addEventListener('click', () => {
    document.querySelector('.menu-popup').classList.toggle('active');
  });

  // Bottom nav active state
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    const link = item.getAttribute('data-link');
    item.addEventListener('click', () => {
      navItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      if (link) window.location.href = link;
    });
  });

  // Search functionality
  const searchInput = document.getElementById("userSearch");
  const searchResults = document.getElementById("searchResults");
  let timeout = null;

  searchInput.addEventListener("input", () => {
    clearTimeout(timeout);
    const query = searchInput.value.trim();

    if (query.length === 0) {
      searchResults.innerHTML = "";
      return;
    }

    timeout = setTimeout(async () => {
      try {
        const res = await fetch(`/follow/users?prefix=${encodeURIComponent(query)}`);
        const data = await res.json();

        searchResults.innerHTML = "";
        data.forEach(user => {
          const div = document.createElement("div");
          div.classList.add("search-result-item");
          div.innerHTML = `
            <img src="/uploads/profile/${user.photo}" alt="Profile Picture">
            <span>${user.user_name}</span>
          `;
          
          // Load chat messages on click
          div.addEventListener("click", async () => {
            loadChatMessages(user.user_id, user.user_name, user.photo);
          });

          searchResults.appendChild(div);
        });
      } catch (err) {
        console.error("Search error:", err);
      }
    }, 300);
  });

  async function loadChatUsers() {
  try {
    const res = await fetch("/chat/users");
    const users = await res.json();

    const list = document.getElementById("chatUserList");
    list.innerHTML = "";

    users.forEach(user => {
      const li = document.createElement("li");
      li.classList.add("chat-user-item");
      li.innerHTML = `
        <div class="profile-photo-mini">
          <img src="/uploads/profile/${user.photo}" alt="Profile Picture">
          <i class="fas fa-user"></i>
        </div>
        ${user.user_name}
      `;

      li.addEventListener("click", () => {
        loadChatMessages(user.user_id, user.user_name, user.photo);
      });

      list.appendChild(li);
    });
  } catch (err) {
    console.error("Failed to load chat users:", err);
  }
}

  // // Load chat users list
  // document.addEventListener("DOMContentLoaded", async () => {
  //   try {
  //     const res = await fetch("/chat/users");
  //     const users = await res.json();

  //     const list = document.getElementById("chatUserList");
  //     list.innerHTML = "";

  //     users.forEach(user => {
  //       const li = document.createElement("li");
  //       li.classList.add("chat-user-item");
  //       li.innerHTML = `
  //         <div class="profile-photo-mini">
  //           <img src="/uploads/profile/${user.photo}" alt="Profile Picture">
  //           <i class="fas fa-user"></i>
  //         </div>
  //         ${user.user_name}
  //       `;

  //       li.addEventListener("click", () => {
  //         loadChatMessages(user.user_id, user.user_name, user.photo);
  //       });

  //       list.appendChild(li);
  //     });
  //   } catch (err) {
  //     console.error("Failed to load chat users:", err);
  //   }
  // });

  let CURRENT_USER_ID = null;

  async function fetchCurrentUserId() {
    const res = await fetch("/session/currentUser");
    const data = await res.json();
    CURRENT_USER_ID = data.userId;
    console.log("Current user ID:", CURRENT_USER_ID);
  }

  

  // Function to load chat messages into container
  async function loadChatMessages(userId, userName, photo) {
    try {
      CURRENT_CHAT_USER_ID = userId; 
      console.log("Fetching messages for user:", userId);

      const chatHeaderImg = document.querySelector(".chat-header img");
      const chatHeaderName = document.querySelector(".chat-header h3");

      if (chatHeaderImg) {
        chatHeaderImg.src = photo ? `/uploads/profile/${photo}` : '/shifu.jpg';
      }
      if (chatHeaderName) {
        chatHeaderName.textContent = userName;
      }

      const res = await fetch(`/chat/messages/${userId}`);
      const messages = await res.json();

      messages.sort((a, b) => new Date(a.sent_at) - new Date(b.sent_at));

      const chatContainer = document.getElementById("chat-container");
      //chatContainer.innerHTML = ""; // clear previous messages

      const messagesContainer = chatContainer.querySelector(".messages");
      messagesContainer.innerHTML = "";

      // messages.forEach(msg => {
      //   const msgDiv = document.createElement("div");
        
      //   if (msg.sender_id != CURRENT_CHAT_USER_ID) { // <-- replace with actual current user ID
      //     msgDiv.classList.add("content-section-user");
      //   }
      //   else
      //   {
      //     msgDiv.classList.add("content-section");
      //   }

      //   msgDiv.innerHTML = `<div class="media-body">
      //     <small class="text-muted">${new Date(msg.sent_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</small>
      //     <p class="article-content">${msg.message}</p>
      //   </div>`;
      //   messagesContainer.appendChild(msgDiv);
      // });
      messages.forEach(msg => appendMessage(msg));

      messages.forEach(msg => {
      if (msg.replied_to_id) {
        const targetEl = document.getElementById(`message-${msg.replied_to_id}`);
        const currentEl = document.getElementById(`message-${msg.chat_id}`);
        if (targetEl && currentEl) {
          const textEl = targetEl.querySelector(".article-content");
          let text = textEl ? textEl.textContent.trim() : "";
          if (text.length > 50) text = text.slice(0, 50) + "...";

          const repliedHTML = `
            <small class="text-muted replied-link" data-target="${msg.replied_to_id}">
              Replied to: ${escapeHtml(text)}
            </small>
          `;
          currentEl.querySelector(".article-metadata").insertAdjacentHTML("beforeend", repliedHTML);

          // Add scroll-on-click
          currentEl.querySelector(".replied-link").addEventListener("click", () => {
            targetEl.scrollIntoView({ behavior: "smooth", block: "center" });
            targetEl.classList.add("highlight-replied");
            setTimeout(() => targetEl.classList.remove("highlight-replied"), 1500);
          });
        }
      }
    });

      // Optional: scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      console.log("Loaded chat with:", userName);
    } catch (err) {
      console.error("Failed to load messages:", err);
    }
  }

// document.addEventListener("DOMContentLoaded", () => {

//   console.log("Script loaded and DOM ready");
//   const chatForm = document.getElementById("chatForm");
//   const messageInput = document.getElementById("messageInput");

//   if (!chatForm) console.error("chatForm not found");
//   if (!messageInput) console.error("messageInput not found");

//   chatForm.addEventListener("submit", async (e) => {
//     e.preventDefault(); // stop page refresh
//   console.log("📨 Submit triggered"); 
  
//   const message = messageInput.value.trim();
//   const userId = CURRENT_CHAT_USER_ID;
//   console.log("✉️ Message:", message);
//   console.log("👤 User ID:", userId);

//   if (!message || !userId) {
//     console.error("❌ Missing message or userId");
//     return;}

//   try {
//       console.log("📡 Sending request...");

//       const res = await fetch(`/chat/send/${userId}`, {
//         method: "POST",
//         headers: { "Content-Type": "application/x-www-form-urlencoded" },
//         body: new URLSearchParams({ message }).toString()
//       });


//       console.log("✅ Response status:", res.status);

//       if (res.ok) {
//         messageInput.value = "";
//       } else
//       {
//         console.error("Failed to send message");
//       }}
//       catch (err)
//       {
//         console.error("Error sending message:", err);
//       }
//     });
//   });
let REPLIED_MESSAGE = null;

function showReplyBox() {
  const replyBox = document.getElementById("replyBox"); // your preview container
  if (REPLIED_MESSAGE) {
    replyBox.innerHTML = `
      Replied to: ${REPLIED_MESSAGE.text} 
      <span id="cancelReply" style="cursor:pointer; margin-left:5px;">×</span>
    `;
    replyBox.style.display = "block";

    document.getElementById("cancelReply").addEventListener("click", () => {
      REPLIED_MESSAGE = null;
      replyBox.style.display = "none";
    });
  } else {
    replyBox.style.display = "none";
  }
}



// This can be placed at the top of your JS file
function appendMessage(msg) {
  const messagesContainer = document.querySelector(".messages");
  const msgDiv = document.createElement("div");

  const sender_id = msg.sender_id ?? msg.senderId;
  const receiver_id = msg.receiver_id ?? msg.receiverId;
  const message = msg.message ?? msg.content;
  const sent_at = msg.sent_at ?? new Date().toISOString();
  //const replied_to_id = msg.replied_to_id || null;
  //⤷
  const msgId = msg.chat_id ?? `${sender_id}-${Date.parse(sent_at)}`;
  msgDiv.id = `message-${msgId}`;
  msgDiv.dataset.msgid = msgId;

  if (sender_id != CURRENT_CHAT_USER_ID) { // <-- replace with actual current user ID
    msgDiv.classList.add("content-section-user");
  }
  else
  {
    msgDiv.classList.add("content-section");
  }

  let repliedTextHTML = "";
  if (msg.replied_to_id) {
    // reply_to_id may be stored as plain msgId (not prefixed with 'message-')
    const targetEl = document.getElementById(`message-${msg.replied_to_id}`);
    if (targetEl) {
      let text = "";
      const contentEl = targetEl.querySelector(".article-content");
      if (contentEl) text = contentEl.textContent.trim();
      if (text.length > 50) text = text.slice(0, 50) + "...";
      repliedTextHTML = `<small class="text-muted replied-link" data-target="${msg.replied_to_id}">Replied to: ${escapeHtml(text)}</small>`;
    }
  }

  msgDiv.innerHTML = `
    <div class="media-body">
      <div class="article-metadata">
      <small class="text-muted">${new Date(sent_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</small>
      ${repliedTextHTML}
      </div>
      <p class="article-content">${message}</p>
      <span class="reply-icon" style="display:none; cursor:pointer; float:right;">⤷</span>
    </div>
  `;

  const link = msgDiv.querySelector(".replied-link");
  if (link) {
    link.addEventListener("click", (e) => {
      const targetId = link.dataset.target;
      const target = document.getElementById(`message-${targetId}`);
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "center" });
        target.classList.add("highlight-replied");
        setTimeout(() => target.classList.remove("highlight-replied"), 1500);
      }
    });
  }

  const replyIcon = msgDiv.querySelector(".reply-icon");
  replyIcon.addEventListener("click", () => {
    const textEl = msgDiv.querySelector(".article-content");
    let text = textEl ? textEl.textContent.trim() : "";
    if (text.length > 50) text = text.slice(0, 50) + "...";
    REPLIED_MESSAGE = { id: msgId, text };
    showReplyBox();
  });

  // hover behavior (if you still want JS hover show/hide instead of CSS)
  msgDiv.addEventListener("mouseenter", () => {
    const ic = msgDiv.querySelector(".reply-icon");
    if (ic) ic.style.display = "inline-block";
  });
  msgDiv.addEventListener("mouseleave", () => {
    const ic = msgDiv.querySelector(".reply-icon");
    if (ic) ic.style.display = "none";
  });

  messagesContainer.appendChild(msgDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}


//   document.addEventListener("DOMContentLoaded", () => {
//   const socket = new SockJS("/ws-chat");
//   const stompClient = Stomp.over(socket);

//   stompClient.connect({}, () => {
//     console.log("✅ Connected to WebSocket");

//     // Subscribe to messages sent *to the current user*
//     stompClient.subscribe(`/topic/messages/${CURRENT_USER_ID}`, (message) => {
//       const msg = JSON.parse(message.body);
//       appendMessage(msg);
//     });
//   });

//   // send a message
//   document.getElementById("chatForm").addEventListener("submit", (e) => {
//     e.preventDefault();
//     const messageText = document.getElementById("messageInput").value;

//     stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
//       senderId: CURRENT_USER_ID,
//       receiverId: CURRENT_CHAT_USER_ID,
//       content: messageText
//     }));

//     document.getElementById("messageInput").value = "";
//   });
// });  //GPT WALLA

document.addEventListener("DOMContentLoaded", async () => {
  await fetchCurrentUserId();
  await loadChatUsers();

  const socket = new SockJS("/ws-chat");
  const stompClient = Stomp.over(socket);

  stompClient.connect({}, () => {
    console.log("✅ Connected to WebSocket");

    stompClient.subscribe(`/topic/messages/${CURRENT_USER_ID}`, async (message) => {
      const msg = JSON.parse(message.body);
      console.log(CURRENT_CHAT_USER_ID);
      
      if ((msg.sender_id === CURRENT_USER_ID)||(msg.senderId === CURRENT_USER_ID)) {
        console.log("I sent this message");
        return;
      }

      // Case 2️⃣: If the message is from the user you’re currently chatting with
      if ((msg.sender_id === CURRENT_CHAT_USER_ID)||(msg.senderId === CURRENT_CHAT_USER_ID)) {
        appendMessage(msg);
      } 
      // Case 3️⃣: Message from another user (not the current chat)
      else {
        await loadChatUsers(); // just refresh list
      }
    });
  });

  const chatForm = document.getElementById("chatForm");
  const messageInput = document.getElementById("messageInput");

  chatForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const messageText = messageInput.value.trim();
    if (!messageText || !CURRENT_CHAT_USER_ID) return;

    const payload = {
    senderId: CURRENT_USER_ID,
    receiverId: CURRENT_CHAT_USER_ID,
    content: messageText
    };

    if (REPLIED_MESSAGE) {
    payload.replied_to_id = REPLIED_MESSAGE.id; // e.g. "ts1600000000000" or "local-..."
    }

    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(payload));

    appendMessage({
      sender_id: CURRENT_USER_ID,
      receiver_id: CURRENT_CHAT_USER_ID,
      message: messageText,
      sent_at: new Date().toISOString(),
      replied_to_id: REPLIED_MESSAGE ? REPLIED_MESSAGE.id : null
    });

    REPLIED_MESSAGE = null;
    showReplyBox();
    messageInput.value = "";
  });

});

function escapeHtml(text) {
  return text
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
</script> -->

<script>
let CURRENT_CHAT_USER_ID = null;

  document.querySelector('.more-btn').addEventListener('click', () => {
    document.querySelector('.menu-popup').classList.toggle('active');
  });

  // Bottom nav active state
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    const link = item.getAttribute('data-link');
    item.addEventListener('click', () => {
      navItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      if (link) window.location.href = link;
    });
  });

  // Search functionality
  const searchInput = document.getElementById("userSearch");
  const searchResults = document.getElementById("searchResults");
  let timeout = null;

  searchInput.addEventListener("input", () => {
    clearTimeout(timeout);
    const query = searchInput.value.trim();

    if (query.length === 0) {
      searchResults.innerHTML = "";
      return;
    }

    timeout = setTimeout(async () => {
      try {
        const res = await fetch(`/follow/users?prefix=${encodeURIComponent(query)}`);
        const data = await res.json();

        searchResults.innerHTML = "";
        data.forEach(user => {
          const div = document.createElement("div");
          div.classList.add("search-result-item");
          div.innerHTML = `
            <img src="/uploads/profile/${user.photo}" alt="Profile Picture">
            <span>${user.user_name}</span>
          `;
          
          // Load chat messages on click
          div.addEventListener("click", async () => {
            loadChatMessages(user.user_id, user.user_name, user.photo);
          });

          searchResults.appendChild(div);
        });
      } catch (err) {
        console.error("Search error:", err);
      }
    }, 300);
  });

  async function loadChatUsers() {
  try {
    const res = await fetch("/chat/users");
    const users = await res.json();

    const list = document.getElementById("chatUserList");
    list.innerHTML = "";

    users.forEach(user => {
      const li = document.createElement("li");
      li.classList.add("chat-user-item");
      li.innerHTML = `
        <div class="profile-photo-mini">
          <img src="/uploads/profile/${user.photo}" alt="Profile Picture">
          <i class="fas fa-user"></i>
        </div>
        ${user.user_name}
      `;

      li.addEventListener("click", () => {
        loadChatMessages(user.user_id, user.user_name, user.photo);
      });

      list.appendChild(li);
    });
  } catch (err) {
    console.error("Failed to load chat users:", err);
  }
}

  

  let CURRENT_USER_ID = null;

  async function fetchCurrentUserId() {
    const res = await fetch("/session/currentUser");
    const data = await res.json();
    CURRENT_USER_ID = data.userId;
    console.log("Current user ID:", CURRENT_USER_ID);
  }

  

  // Function to load chat messages into container
  async function loadChatMessages(userId, userName, photo) {
    try {
      CURRENT_CHAT_USER_ID = userId; 
      console.log("Fetching messages for user:", userId);

      const chatHeaderImg = document.querySelector(".chat-header img");
      const chatHeaderName = document.querySelector(".chat-header h3");

      if (chatHeaderImg) {
        chatHeaderImg.src = photo ? `/uploads/profile/${photo}` : '/shifu.jpg';
      }
      if (chatHeaderName) {
        chatHeaderName.textContent = userName;
      }

      const res = await fetch(`/chat/messages/${userId}`);
      const messages = await res.json();
      const chatContainer = document.getElementById("chat-container");
      //chatContainer.innerHTML = ""; // clear previous messages

      const messagesContainer = chatContainer.querySelector(".messages");
      messagesContainer.innerHTML = "";

       
      messages.forEach(msg => appendMessage(msg));

    //   messages.forEach(msg => {
    //   if (msg.replied_to_id) {
    //     const targetEl = document.getElementById(`message-${msg.replied_to_id}`);
    //     const currentEl = document.getElementById(`message-${msg.chat_id}`);
    //     if (targetEl && currentEl) {
    //       const textEl = targetEl.querySelector(".article-content");
    //       let text = textEl ? textEl.textContent.trim() : "";
    //       if (text.length > 50) text = text.slice(0, 50) + "...";

    //       const repliedHTML = `
    //         <small class="text-muted replied-link" data-target="${msg.replied_to_id}">
    //           Replied to: ${escapeHtml(text)}
    //         </small>
    //       `;
    //       currentEl.querySelector(".article-metadata").insertAdjacentHTML("beforeend", repliedHTML);

    //       // Add scroll-on-click
    //       currentEl.querySelector(".replied-link").addEventListener("click", () => {
    //         targetEl.scrollIntoView({ behavior: "smooth", block: "center" });
    //         targetEl.classList.add("highlight-replied");
    //         setTimeout(() => targetEl.classList.remove("highlight-replied"), 1500);
    //       });
    //     }
    //   }
    // });

      // Optional: scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      console.log("Loaded chat with:", userName);
    } catch (err) {
      console.error("Failed to load messages:", err);
    }
  }


let REPLIED_MESSAGE = null;

function showReplyBox() {
  const replyBox = document.getElementById("replyBox"); // your preview container
  if (REPLIED_MESSAGE) {
    replyBox.innerHTML = `
      Replied to: ${REPLIED_MESSAGE.text} 
      <span id="cancelReply" style="cursor:pointer; margin-left:5px;">×</span>
    `;
    replyBox.style.display = "block";

    document.getElementById("cancelReply").addEventListener("click", () => {
      REPLIED_MESSAGE = null;
      replyBox.style.display = "none";
    });
  } else {
    replyBox.style.display = "none";
  }
}



// This can be placed at the top of your JS file
function appendMessage(msg) {
  const messagesContainer = document.querySelector(".messages");
  const msgDiv = document.createElement("div");
  msgDiv.style.position = "relative";

  const sender_id = msg.sender_id ?? msg.senderId;
  const receiver_id = msg.receiver_id ?? msg.receiverId;
  const message = msg.message ?? msg.content;
  const sent_at = msg.sent_at ?? new Date().toISOString();
  //const replied_to_id = msg.replied_to_id || null;
  //⤷
  const msgId = msg.chat_id ?? `${sender_id}-${Date.parse(sent_at)}`;
  msgDiv.id = `message-${msgId}`;
  msgDiv.dataset.msgid = msgId;

  if (sender_id != CURRENT_CHAT_USER_ID) { // <-- replace with actual current user ID
    msgDiv.classList.add("content-section-user");
  }
  else
  {
    msgDiv.classList.add("content-section");
  }

  let repliedTextHTML = "";
  if (msg.replied_to_id) {
    // reply_to_id may be stored as plain msgId (not prefixed with 'message-')
    const targetEl = document.getElementById(`message-${msg.replied_to_id}`);
    if (targetEl) {
      let text = "";
      const contentEl = targetEl.querySelector(".article-content");
      if (contentEl) text = contentEl.textContent.trim();
      if (text.length > 50) text = text.slice(0, 50) + "...";
      repliedTextHTML = `<small class="text-muted replied-link" data-target="${msg.replied_to_id}">Replied to: ${escapeHtml(text)}</small>`;
    }
  }

  msgDiv.innerHTML = `
    <div class="media-body">
      <div class="article-metadata">
      <small class="text-muted">${new Date(sent_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</small>
      ${repliedTextHTML}
      </div>
      <p class="article-content">${message}</p>
      <span class="reply-icon" style="display:none; cursor:pointer; float:right;">⤷</span>
    </div>
  `;

  if (msg.media && msg.media.fileUrl) {
  const { fileUrl, fileType } = msg.media;
  const mediaContainer = document.createElement("div");
  mediaContainer.classList.add("chat-media");

  if (fileType === "PHOTO" || fileType.startsWith("image/")) {
    mediaContainer.innerHTML = `
      <img src="${fileUrl}" alt="sent image">
    `;
  } else if (fileType === "VIDEO" || fileType.startsWith("video/")) {
    mediaContainer.innerHTML = `
      <video src="${fileUrl}" muted></video>
    `;
  } else {
    mediaContainer.innerHTML = `
      <a href="${fileUrl}" target="_blank" style="display:block; margin-top:5px; color:#007bff;">
        📎 View Attachment
      </a>
    `;
  }

  // Attach click event for full-screen preview
  const mediaEl = mediaContainer.querySelector("img, video");
  if (mediaEl) {
    mediaEl.addEventListener("click", () => openMediaModal(fileUrl, fileType));
  }

  msgDiv.querySelector(".article-content").after(mediaContainer);
}


  const link = msgDiv.querySelector(".replied-link");
  if (link) {
    link.addEventListener("click", (e) => {
      const targetId = link.dataset.target;
      const target = document.getElementById(`message-${targetId}`);
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "center" });
        target.classList.add("highlight-replied");
        setTimeout(() => target.classList.remove("highlight-replied"), 1500);
      }
    });
  }

  const replyIcon = msgDiv.querySelector(".reply-icon");
  replyIcon.addEventListener("click", () => {
    const textEl = msgDiv.querySelector(".article-content");
    let text = textEl ? textEl.textContent.trim() : "";
    if (text.length > 50) text = text.slice(0, 50) + "...";
    REPLIED_MESSAGE = { id: msgId, text };
    showReplyBox();
  });

  // hover behavior (if you still want JS hover show/hide instead of CSS)
  msgDiv.addEventListener("mouseenter", () => {
    const ic = msgDiv.querySelector(".reply-icon");
    if (ic) ic.style.display = "inline-block";
  });
  msgDiv.addEventListener("mouseleave", () => {
    const ic = msgDiv.querySelector(".reply-icon");
    if (ic) ic.style.display = "none";
  });

  messagesContainer.appendChild(msgDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}




document.addEventListener("DOMContentLoaded", async () => {
  await fetchCurrentUserId();
  await loadChatUsers();

  const socket = new SockJS("/ws-chat");
  const stompClient = Stomp.over(socket);

  stompClient.connect({}, () => {
    console.log("✅ Connected to WebSocket");

    stompClient.subscribe(`/topic/messages/${CURRENT_USER_ID}`, async (message) => {
      const msg = JSON.parse(message.body);
      console.log(CURRENT_CHAT_USER_ID);
      
      if ((msg.sender_id === CURRENT_USER_ID)||(msg.senderId === CURRENT_USER_ID)) {
        console.log("I sent this message");
        return;
      }

      // Case 2️⃣: If the message is from the user you’re currently chatting with
      if ((msg.sender_id === CURRENT_CHAT_USER_ID)||(msg.senderId === CURRENT_CHAT_USER_ID)) {
        appendMessage(msg);
      } 
      // Case 3️⃣: Message from another user (not the current chat)
      else {
        await loadChatUsers(); // just refresh list
      }
    });
  });

  const chatForm = document.getElementById("chatForm");
  const messageInput = document.getElementById("messageInput");

  // chatForm.addEventListener("submit", (e) => {
  //   e.preventDefault();

  //   const messageText = messageInput.value.trim();
  //   if (!messageText || !CURRENT_CHAT_USER_ID) return;

  //   const payload = {
  //   senderId: CURRENT_USER_ID,
  //   receiverId: CURRENT_CHAT_USER_ID,
  //   content: messageText
  //   };

  //   if (REPLIED_MESSAGE) {
  //   payload.replied_to_id = REPLIED_MESSAGE.id; // e.g. "ts1600000000000" or "local-..."
  //   }

  //   stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(payload));

  //   appendMessage({
  //     sender_id: CURRENT_USER_ID,
  //     receiver_id: CURRENT_CHAT_USER_ID,
  //     message: messageText,
  //     sent_at: new Date().toISOString(),
  //     replied_to_id: REPLIED_MESSAGE ? REPLIED_MESSAGE.id : null
  //   });

  //   REPLIED_MESSAGE = null;
  //   showReplyBox();
  //   messageInput.value = "";
  // });
  chatForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const messageText = messageInput.value.trim();
  const mediaFile = document.getElementById("mediaInput").files[0];

  if (!messageText && !mediaFile) return;
  if (!CURRENT_CHAT_USER_ID) return;

  let mediaData = null;

  // 🖼 Upload file first (if exists)
  if (mediaFile) {
    const formData = new FormData();
    formData.append("file", mediaFile);

    try {
      const res = await fetch("/api/media/upload", {
        method: "POST",
        body: formData,
      });
      mediaData = await res.json(); // expect { fileUrl, fileType }

      if (mediaData.fileType.startsWith("image/")) {
        mediaData.fileType = "PHOTO";
      } else if (mediaData.fileType.startsWith("video/")) {
        mediaData.fileType = "VIDEO";
      } else {
        mediaData = null; // unsupported
      }
    } catch (err) {
      console.error("Media upload failed:", err);
      return;
    }
  }

  // 📤 Build message payload
  const payload = {
    senderId: CURRENT_USER_ID,
    receiverId: CURRENT_CHAT_USER_ID,
    content: messageText || null,
    replied_to_id: REPLIED_MESSAGE ? REPLIED_MESSAGE.id : null,
    media: mediaData ? mediaData : null,
  };

  stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(payload));

  appendMessage({
    sender_id: CURRENT_USER_ID,
    receiver_id: CURRENT_CHAT_USER_ID,
    message: messageText || "",
    sent_at: new Date().toISOString(),
    replied_to_id: REPLIED_MESSAGE ? REPLIED_MESSAGE.id : null,
    media: mediaData,
  });

  // Reset input
  REPLIED_MESSAGE = null;
  showReplyBox();
  messageInput.value = "";
  document.getElementById("mediaInput").value = "";
});


});

function escapeHtml(text) {
  return text
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function openMediaModal(fileUrl, fileType) {
  const modal = document.getElementById("mediaModal");
  const modalImg = document.getElementById("modalImage");
  const modalVideo = document.getElementById("modalVideo");
  const closeBtn = document.querySelector(".close-modal");

  // Hide both, then show the correct one
  modalImg.style.display = "none";
  modalVideo.style.display = "none";

  if (fileType === "PHOTO" || fileType.startsWith("image/")) {
    modalImg.src = fileUrl;
    modalImg.style.display = "block";
  } else if (fileType === "VIDEO" || fileType.startsWith("video/")) {
    modalVideo.src = fileUrl;
    modalVideo.style.display = "block";
  }

  modal.style.display = "flex";

  closeBtn.onclick = () => {
    modal.style.display = "none";
    modalVideo.pause();
  };

  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.style.display = "none";
      modalVideo.pause();
    }
  };
}

 //see this script. every thing works except for the rendering of 'replied to: ..' in the older messages that are loaded, why?
</script>