<!DOCTYPE html>
<!-- {% load static %} -->
<html xmlns:th="http://www.thymeleaf.org"></html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/chat.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Oxygen:wght@300;400;700&family=Quicksand:wght@300..700&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>


</head>
<body>
    
    <nav class="bottom-nav">
    <div class="nav-item">
      <i class="fa-solid fa-house active"></i>
      <span>Home</span>
    </div>
    <div class="nav-item">
      <i class="fa-solid fa-magnifying-glass"></i>
      <span>Search</span>
    </div>

    <div class="nav-item">
      <i class="fa-solid fa-circle-plus"></i>
      <span>Create</span>
    </div>

    <div class="nav-item" data-link="/chat">
      <i class="fa-regular fa-comment" ></i>
      <span>Messages</span>
    </div>

    <div class="nav-item" data-link="/profile">
      <i class="fa-regular fa-user"></i>
      <span>Profile</span>
    </div>


    <div class="nav-item" id="more-nav">
      <i class="fa-solid fa-bars more-btn"></i>
      <span>More</span>
    </div>

    <div class="menu-popup">
      <a href="/settings" class="menu-item">Settings</a>
      <div class="menu-item">Your activity</div>
      <div class="menu-item">Saved</div>
      <div class="menu-item">Switch appearance</div>
      <div class="menu-item">Report a problem</div>
      <div class="menu-item">Switch accounts</div>
      <div class="menu-item">Log out</div>
    </div>
    
  </nav>
  


    <div class="container">
        <!-- Sidebar with Lessons -->
        <div class="sidebar">
            <h3>Chats</h3>

            <div class="search-container">
            <form method="post" action="{% url 'discussion' course_id=course.course_id %}" class="search-box"> 
                <div class="search-icon">
                <i class="fa-solid fa-magnifying-glass"></i>
                </div>
            <input type="text" id="userSearch" placeholder="Search users...">
            </form>
            <div id="searchResults" class="search-results"></div>
            </div>
            <ul id="chatUserList"> 
            </ul>
        </div>

        <div class="content">
            <div class="discussion_forum">
                <div class="heading">
                <h1>Messages</h1>
                <h4></h4>
                </div>
            
            
                <div id="chat-container">
                    <div class="chat-header" >
                        <div class="profile-photo-mini">
                            <img th:src="${chatUser != null ? chatUser.photo ?: '/shifu.jpg' : '/shifu.jpg'}" alt="Profile Picture">

                            <i class="fas fa-user"></i> <!-- Font Awesome user icon -->
                           
                        </div>
                        <h3 th:if="${chatUser != null}" th:text="${chatUser.user_name}"></h3>
                    </div>
                    <div class="messages">
                      <div th:each="msg : ${messages}" >
                        <div class="media-body">
                          <small class="text-muted" th:text="${#dates.format(msg.sent_at, 'HH:mm')}"></small>
                          <p class="article-content" th:text="${msg.message}"></p>
                        </div>
                      </div>
                    </div>
                <!--<article class="content-section">
                   
                        <div class="media-body">
                            <div class="article-metadata">
                                
                                <small class="text-muted">21:09</small>
                                <small class="text-muted">
                                    Replied to: Hi Master Shifu, nice profile pic! 
                                </small>
                            </div>
                            <p class="article-content">Haha thanks</p>
                        </div>
                    </article>
                 -->
            
            
                <form id="chatForm" class="typing-box"> 
                    <input type="text" id="messageInput" placeholder="Type your message...">
                    <button type="submit" class="btn btn-primary">Send</button>
                </form> 
            </div>
            </div>
        </div>
    </div>
    
</body>
</html>



<script>
  // Menu toggle
  document.querySelector('.more-btn').addEventListener('click', () => {
    document.querySelector('.menu-popup').classList.toggle('active');
  });

  // Bottom nav active state
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    const link = item.getAttribute('data-link');
    item.addEventListener('click', () => {
      navItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      if (link) window.location.href = link;
    });
  });

  // Search functionality
  const searchInput = document.getElementById("userSearch");
  const searchResults = document.getElementById("searchResults");
  let timeout = null;

  searchInput.addEventListener("input", () => {
    clearTimeout(timeout);
    const query = searchInput.value.trim();

    if (query.length === 0) {
      searchResults.innerHTML = "";
      return;
    }

    timeout = setTimeout(async () => {
      try {
        const res = await fetch(`/follow/users?prefix=${encodeURIComponent(query)}`);
        const data = await res.json();

        searchResults.innerHTML = "";
        data.forEach(user => {
          const div = document.createElement("div");
          div.classList.add("search-result-item");
          div.innerHTML = `
            <img src="${user.photo}" alt="Profile Picture">
            <span>${user.user_name}</span>
          `;
          
          // Load chat messages on click
          div.addEventListener("click", async () => {
            loadChatMessages(user.user_id, user.user_name);
          });

          searchResults.appendChild(div);
        });
      } catch (err) {
        console.error("Search error:", err);
      }
    }, 300);
  });

  // Load chat users list
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const res = await fetch("/chat/users");
      const users = await res.json();

      const list = document.getElementById("chatUserList");
      list.innerHTML = "";

      users.forEach(user => {
        const li = document.createElement("li");
        li.classList.add("chat-user-item");
        li.innerHTML = `
          <div class="profile-photo-mini">
            <img src="${user.photo}" alt="Profile Picture">
            <i class="fas fa-user"></i>
          </div>
          ${user.user_name}
        `;

        li.addEventListener("click", () => {
          loadChatMessages(user.user_id, user.user_name);
        });

        list.appendChild(li);
      });
    } catch (err) {
      console.error("Failed to load chat users:", err);
    }
  });

  let CURRENT_USER_ID = null;

  async function fetchCurrentUserId() {
    const res = await fetch("/session/currentUser");
    const data = await res.json();
    CURRENT_USER_ID = data.userId;
    console.log("Current user ID:", CURRENT_USER_ID);
  }

  

  // Function to load chat messages into container
  async function loadChatMessages(userId, userName) {
    try {
      CURRENT_CHAT_USER_ID = userId; 
      console.log("Fetching messages for user:", userId);
      const res = await fetch(`/chat/messages/${userId}`);
      const messages = await res.json();
      const chatContainer = document.getElementById("chat-container");
      //chatContainer.innerHTML = ""; // clear previous messages

      const messagesContainer = chatContainer.querySelector(".messages");
      messagesContainer.innerHTML = "";

      messages.forEach(msg => {
        const msgDiv = document.createElement("div");
        
        if (msg.sender_id != CURRENT_CHAT_USER_ID) { // <-- replace with actual current user ID
          msgDiv.classList.add("content-section-user");
        }
        else
        {
          msgDiv.classList.add("content-section");
        }

        msgDiv.innerHTML = `<div class="media-body">
          <small class="text-muted">${new Date(msg.sent_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</small>
          <p class="article-content">${msg.message}</p>
        </div>`;
        messagesContainer.appendChild(msgDiv);
      });

      // Optional: scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      console.log("Loaded chat with:", userName);
    } catch (err) {
      console.error("Failed to load messages:", err);
    }
  }

// document.addEventListener("DOMContentLoaded", () => {

//   console.log("Script loaded and DOM ready");
//   const chatForm = document.getElementById("chatForm");
//   const messageInput = document.getElementById("messageInput");

//   if (!chatForm) console.error("chatForm not found");
//   if (!messageInput) console.error("messageInput not found");

//   chatForm.addEventListener("submit", async (e) => {
//     e.preventDefault(); // stop page refresh
//   console.log("üì® Submit triggered"); 
  
//   const message = messageInput.value.trim();
//   const userId = CURRENT_CHAT_USER_ID;
//   console.log("‚úâÔ∏è Message:", message);
//   console.log("üë§ User ID:", userId);

//   if (!message || !userId) {
//     console.error("‚ùå Missing message or userId");
//     return;}

//   try {
//       console.log("üì° Sending request...");

//       const res = await fetch(`/chat/send/${userId}`, {
//         method: "POST",
//         headers: { "Content-Type": "application/x-www-form-urlencoded" },
//         body: new URLSearchParams({ message }).toString()
//       });


//       console.log("‚úÖ Response status:", res.status);

//       if (res.ok) {
//         messageInput.value = "";
//       } else
//       {
//         console.error("Failed to send message");
//       }}
//       catch (err)
//       {
//         console.error("Error sending message:", err);
//       }
//     });
//   });

// This can be placed at the top of your JS file
function appendMessage(msg) {
  const messagesContainer = document.querySelector(".messages");
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("content-section");

  const sender_id = msg.sender_id ?? msg.senderId;
  const receiver_id = msg.receiver_id ?? msg.receiverId;
  const message = msg.message ?? msg.content;
  const sent_at = msg.sent_at ?? new Date().toISOString();

  if (sender_id != CURRENT_CHAT_USER_ID) { // <-- replace with actual current user ID
    msgDiv.classList.add("content-section-user");
  }
  else
  {
    msgDiv.classList.add("content-section");
  }

  msgDiv.innerHTML = `
    <div class="media-body">
      <small class="text-muted">${new Date(sent_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</small>
      <p class="article-content">${message}</p>
    </div>
  `;

  messagesContainer.appendChild(msgDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}


//   document.addEventListener("DOMContentLoaded", () => {
//   const socket = new SockJS("/ws-chat");
//   const stompClient = Stomp.over(socket);

//   stompClient.connect({}, () => {
//     console.log("‚úÖ Connected to WebSocket");

//     // Subscribe to messages sent *to the current user*
//     stompClient.subscribe(`/topic/messages/${CURRENT_USER_ID}`, (message) => {
//       const msg = JSON.parse(message.body);
//       appendMessage(msg);
//     });
//   });

//   // send a message
//   document.getElementById("chatForm").addEventListener("submit", (e) => {
//     e.preventDefault();
//     const messageText = document.getElementById("messageInput").value;

//     stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
//       senderId: CURRENT_USER_ID,
//       receiverId: CURRENT_CHAT_USER_ID,
//       content: messageText
//     }));

//     document.getElementById("messageInput").value = "";
//   });
// });  //GPT WALLA

document.addEventListener("DOMContentLoaded", async () => {
  await fetchCurrentUserId();

  const socket = new SockJS("/ws-chat");
  const stompClient = Stomp.over(socket);

  stompClient.connect({}, () => {
    console.log("‚úÖ Connected to WebSocket");

    stompClient.subscribe(`/topic/messages/${CURRENT_USER_ID}`, (message) => {
      const msg = JSON.parse(message.body);
      appendMessage(msg);
    });
  });

  const chatForm = document.getElementById("chatForm");
  const messageInput = document.getElementById("messageInput");

  chatForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const messageText = messageInput.value.trim();
    if (!messageText || !CURRENT_CHAT_USER_ID) return;

    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
      senderId: CURRENT_USER_ID,
      receiverId: CURRENT_CHAT_USER_ID,
      content: messageText
    }));

    appendMessage({
      sender_id: CURRENT_USER_ID,
      receiver_id: CURRENT_CHAT_USER_ID,
      message: messageText,
      sent_at: new Date().toISOString()
    });

    messageInput.value = "";
  });

});


</script>
